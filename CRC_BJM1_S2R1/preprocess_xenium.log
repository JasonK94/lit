2025-04-18 17:12:33,256 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 17:12:33,261 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R1
2025-04-18 17:12:33,264 [INFO] Sample ID set to: CRC_BJM1_S2R1
2025-04-18 17:12:33,268 [INFO] --- Step 1: Loading Data ---
2025-04-18 17:12:33,276 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cell_feature_matrix.h5
2025-04-18 17:12:34,349 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cells.parquet
2025-04-18 17:12:34,431 [INFO] Initial AnnData object shape: (67645, 5001)
2025-04-18 17:12:34,435 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 17:12:34,438 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 17:12:34,441 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 17:12:34,444 [INFO] Joining metadata from cells parquet file.
2025-04-18 17:12:34,492 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 17:12:34,496 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 17:12:34,502 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide2(0050585)_Region1
2025-04-18 17:12:34,507 [INFO] Found 10 potential core info files.
2025-04-18 17:12:34,554 [INFO] Found 8190 overlapping cells for Core 13 in 13_cells_stats.csv.
2025-04-18 17:12:34,658 [INFO] Found 9085 overlapping cells for Core 14 in 14_cells_stats.csv.
2025-04-18 17:12:34,722 [INFO] Found 2638 overlapping cells for Core 1 in 1_cells_stats.csv.
2025-04-18 17:12:34,762 [INFO] Found 7281 overlapping cells for Core 25 in 25_cells_stats.csv.
2025-04-18 17:12:34,822 [INFO] Found 6403 overlapping cells for Core 26 in 26_cells_stats.csv.
2025-04-18 17:12:34,878 [INFO] Found 3737 overlapping cells for Core 2 in 2_cells_stats.csv.
2025-04-18 17:12:34,921 [INFO] Found 6759 overlapping cells for Core 37 in 37_cells_stats.csv.
2025-04-18 17:12:34,981 [INFO] Found 9320 overlapping cells for Core 38 in 38_cells_stats.csv.
2025-04-18 17:12:35,050 [INFO] Found 6934 overlapping cells for Core 49 in 49_cells_stats.csv.
2025-04-18 17:12:35,108 [INFO] Found 7201 overlapping cells for Core 50 in 50_cells_stats.csv.
2025-04-18 17:12:35,153 [INFO] Assigned Core IDs to 67548/67645 cells.
2025-04-18 17:12:35,158 [INFO] Core value counts:
Core
38      9320
14      9085
13      8190
25      7281
50      7201
49      6934
37      6759
26      6403
2       3737
1       2638
<NA>      97
Name: count, dtype: int64
2025-04-18 17:12:35,161 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 17:12:35,173 [INFO] Identified 0 mitochondrial genes.
2025-04-18 17:12:35,177 [INFO] Identified 1 ribosomal genes.
2025-04-18 17:12:35,180 [INFO] Identified 4 hemoglobin genes.
2025-04-18 17:12:35,395 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 67645, 'n_genes': 5001, 'median_total_counts': 246.0, 'mean_total_counts': 329.0464782714844, 'median_n_genes_by_counts': 206.0, 'mean_n_genes_by_counts': 247.12465075024022, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 17:12:36,761 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S2R1_qc_violin_before_filter.png
2025-04-18 17:12:36,765 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 17:12:36,768 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 17:12:37,297 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 17:12:37,424 [INFO] Cells to remove based on min_genes (3): 208
2025-04-18 17:12:37,438 [INFO] Cells to remove based on min_counts (10): 593
2025-04-18 17:12:37,443 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 17:12:37,688 [INFO] Filtered cells: 593 cells removed based on combined criteria.
2025-04-18 17:12:37,692 [INFO] AnnData shape after QC filtering: (67052, 5000)
2025-04-18 17:12:39,056 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S2R1_qc_violin_after_filter.png
2025-04-18 17:12:39,058 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 17:12:39,255 [INFO] Saved log-normalized data to adata.raw
2025-04-18 17:12:39,258 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 17:12:39,261 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 17:12:39,383 [INFO] Applying log1p transformation.
2025-04-18 17:12:39,459 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 17:12:40,107 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 17:12:40,117 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 17:12:40,120 [INFO] --- Step 6: Scaling Data ---
2025-04-18 17:12:40,124 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 17:12:43,150 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 17:12:43,153 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 17:12:43,157 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 17:12:49,606 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 17:12:49,621 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 17:12:49,625 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 17:12:49,628 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 17:12:57,007 [INFO] --- Step 9: Clustering ---
2025-04-18 17:12:57,012 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 17:14:28,073 [INFO] Found 20 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 17:14:28,080 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 17:14:28,084 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 17:15:08,926 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_umap_clusters_leiden_res0.8.png
2025-04-18 17:15:14,687 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_spatial_clusters_leiden_res0.8.png
2025-04-18 17:15:14,689 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 17:15:14,691 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 17:16:30,556 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 17:16:32,496 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S2R1_rank_genes_clusters_leiden_res0.8.png
2025-04-18 17:16:32,500 [INFO] --- Step 12: Saving Results ---
2025-04-18 17:16:32,508 [INFO] Final QC Summary: {'n_cells': 67052, 'n_genes': 2000, 'median_total_counts': 248.0, 'mean_total_counts': 331.9176330566406, 'median_n_genes_by_counts': 208.0, 'mean_n_genes_by_counts': 249.2720724214043, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 17:16:38,375 [ERROR] Failed to save AnnData object: Can't implicitly convert non-string objects to strings
2025-04-18 17:16:38,381 [INFO] Preprocessing pipeline finished.
2025-04-18 17:31:35,252 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 17:31:35,257 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R1
2025-04-18 17:31:35,262 [INFO] Sample ID set to: CRC_BJM1_S2R1_fix1
2025-04-18 17:31:35,266 [INFO] --- Step 1: Loading Data ---
2025-04-18 17:31:35,274 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cell_feature_matrix.h5
2025-04-18 17:31:36,508 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cells.parquet
2025-04-18 17:31:36,567 [INFO] Initial AnnData object shape: (67645, 5001)
2025-04-18 17:31:36,571 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 17:31:36,575 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 17:31:36,579 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 17:31:36,583 [INFO] Joining metadata from cells parquet file.
2025-04-18 17:31:36,620 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 17:31:36,624 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 17:31:36,631 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide2(0050585)_Region1
2025-04-18 17:31:36,637 [INFO] Found 10 potential core info files.
2025-04-18 17:31:36,682 [INFO] Found 8190 overlapping cells for Core 13 in 13_cells_stats.csv.
2025-04-18 17:31:36,776 [INFO] Found 9085 overlapping cells for Core 14 in 14_cells_stats.csv.
2025-04-18 17:31:36,843 [INFO] Found 2638 overlapping cells for Core 1 in 1_cells_stats.csv.
2025-04-18 17:31:36,886 [INFO] Found 7281 overlapping cells for Core 25 in 25_cells_stats.csv.
2025-04-18 17:31:36,951 [INFO] Found 6403 overlapping cells for Core 26 in 26_cells_stats.csv.
2025-04-18 17:31:37,010 [INFO] Found 3737 overlapping cells for Core 2 in 2_cells_stats.csv.
2025-04-18 17:31:37,059 [INFO] Found 6759 overlapping cells for Core 37 in 37_cells_stats.csv.
2025-04-18 17:31:37,125 [INFO] Found 9320 overlapping cells for Core 38 in 38_cells_stats.csv.
2025-04-18 17:31:37,202 [INFO] Found 6934 overlapping cells for Core 49 in 49_cells_stats.csv.
2025-04-18 17:31:37,266 [INFO] Found 7201 overlapping cells for Core 50 in 50_cells_stats.csv.
2025-04-18 17:31:37,314 [INFO] Assigned Core IDs to 67548/67645 cells.
2025-04-18 17:31:37,321 [INFO] Core value counts:
Core
38      9320
14      9085
13      8190
25      7281
50      7201
49      6934
37      6759
26      6403
2       3737
1       2638
<NA>      97
Name: count, dtype: int64
2025-04-18 17:31:37,325 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 17:31:37,338 [INFO] Identified 0 mitochondrial genes.
2025-04-18 17:31:37,342 [INFO] Identified 1 ribosomal genes.
2025-04-18 17:31:37,346 [INFO] Identified 4 hemoglobin genes.
2025-04-18 17:31:37,663 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 67645, 'n_genes': 5001, 'median_total_counts': 246.0, 'mean_total_counts': 329.0464782714844, 'median_n_genes_by_counts': 206.0, 'mean_n_genes_by_counts': 247.12465075024022, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 17:31:39,081 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S2R1_qc_violin_before_filter.png
2025-04-18 17:31:39,085 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 17:31:39,089 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 17:31:39,803 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 17:31:39,984 [INFO] Cells to remove based on min_genes (3): 208
2025-04-18 17:31:40,001 [INFO] Cells to remove based on min_counts (10): 593
2025-04-18 17:31:40,008 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 17:31:40,401 [INFO] Filtered cells: 593 cells removed based on combined criteria.
2025-04-18 17:31:40,406 [INFO] AnnData shape after QC filtering: (67052, 5000)
2025-04-18 17:31:41,769 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S2R1_qc_violin_after_filter.png
2025-04-18 17:31:41,774 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 17:31:42,098 [INFO] Saved log-normalized data to adata.raw
2025-04-18 17:31:42,103 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 17:31:42,107 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 17:31:42,306 [INFO] Applying log1p transformation.
2025-04-18 17:31:42,433 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 17:31:42,893 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 17:31:42,904 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 17:31:42,908 [INFO] --- Step 6: Scaling Data ---
2025-04-18 17:31:42,912 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 17:31:46,217 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 17:31:46,221 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 17:31:46,225 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 17:31:53,028 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 17:31:53,044 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 17:31:53,047 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 17:31:53,048 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 17:32:00,839 [INFO] --- Step 9: Clustering ---
2025-04-18 17:32:00,845 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 17:33:38,624 [INFO] Found 20 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 17:33:38,629 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 17:33:38,633 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 17:34:20,046 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_umap_clusters_leiden_res0.8.png
2025-04-18 17:34:25,713 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_spatial_clusters_leiden_res0.8.png
2025-04-18 17:34:25,717 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 17:34:25,721 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 17:35:06,668 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 17:35:08,485 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S2R1_rank_genes_clusters_leiden_res0.8.png
2025-04-18 17:35:08,489 [INFO] --- Step 12: Saving Results ---
2025-04-18 17:35:08,493 [WARNING] Temporarily removing 'clusters_leiden_res0.8_rank_genes_wilcoxon' from adata.uns for debugging saving.
2025-04-18 17:35:08,502 [INFO] Final QC Summary: {'n_cells': 67052, 'n_genes': 2000, 'median_total_counts': 248.0, 'mean_total_counts': 331.9176330566406, 'median_n_genes_by_counts': 208.0, 'mean_n_genes_by_counts': 249.2720724214043, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 17:35:14,114 [ERROR] Failed to save AnnData object: Can't implicitly convert non-string objects to strings
2025-04-18 17:37:27,625 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 17:37:27,629 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R1
2025-04-18 17:37:27,632 [INFO] Sample ID set to: CRC_BJM1_S2R1_fix2
2025-04-18 17:37:27,636 [INFO] --- Step 1: Loading Data ---
2025-04-18 17:37:27,643 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cell_feature_matrix.h5
2025-04-18 17:37:28,689 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cells.parquet
2025-04-18 17:37:28,740 [INFO] Initial AnnData object shape: (67645, 5001)
2025-04-18 17:37:28,745 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 17:37:28,750 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 17:37:28,754 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 17:37:28,759 [INFO] Joining metadata from cells parquet file.
2025-04-18 17:37:28,791 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 17:37:28,796 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 17:37:28,803 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide2(0050585)_Region1
2025-04-18 17:37:28,812 [INFO] Found 10 potential core info files.
2025-04-18 17:37:28,843 [INFO] Found 8190 overlapping cells for Core 13 in 13_cells_stats.csv.
2025-04-18 17:37:28,931 [INFO] Found 9085 overlapping cells for Core 14 in 14_cells_stats.csv.
2025-04-18 17:37:29,006 [INFO] Found 2638 overlapping cells for Core 1 in 1_cells_stats.csv.
2025-04-18 17:37:29,054 [INFO] Found 7281 overlapping cells for Core 25 in 25_cells_stats.csv.
2025-04-18 17:37:29,125 [INFO] Found 6403 overlapping cells for Core 26 in 26_cells_stats.csv.
2025-04-18 17:37:29,190 [INFO] Found 3737 overlapping cells for Core 2 in 2_cells_stats.csv.
2025-04-18 17:37:29,242 [INFO] Found 6759 overlapping cells for Core 37 in 37_cells_stats.csv.
2025-04-18 17:37:29,311 [INFO] Found 9320 overlapping cells for Core 38 in 38_cells_stats.csv.
2025-04-18 17:37:29,391 [INFO] Found 6934 overlapping cells for Core 49 in 49_cells_stats.csv.
2025-04-18 17:37:29,457 [INFO] Found 7201 overlapping cells for Core 50 in 50_cells_stats.csv.
2025-04-18 17:37:29,507 [INFO] Assigned Core IDs to 67548/67645 cells.
2025-04-18 17:37:29,514 [INFO] Core value counts:
Core
38      9320
14      9085
13      8190
25      7281
50      7201
49      6934
37      6759
26      6403
2       3737
1       2638
<NA>      97
Name: count, dtype: int64
2025-04-18 17:37:29,519 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 17:37:29,533 [INFO] Identified 0 mitochondrial genes.
2025-04-18 17:37:29,538 [INFO] Identified 1 ribosomal genes.
2025-04-18 17:37:29,542 [INFO] Identified 4 hemoglobin genes.
2025-04-18 17:37:29,783 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 67645, 'n_genes': 5001, 'median_total_counts': 246.0, 'mean_total_counts': 329.0464782714844, 'median_n_genes_by_counts': 206.0, 'mean_n_genes_by_counts': 247.12465075024022, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 17:37:31,211 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S2R1_qc_violin_before_filter.png
2025-04-18 17:37:31,216 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 17:37:31,221 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 17:37:32,813 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 17:37:32,920 [INFO] Cells to remove based on min_genes (3): 208
2025-04-18 17:37:32,936 [INFO] Cells to remove based on min_counts (10): 593
2025-04-18 17:37:32,943 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 17:37:33,159 [INFO] Filtered cells: 593 cells removed based on combined criteria.
2025-04-18 17:37:33,164 [INFO] AnnData shape after QC filtering: (67052, 5000)
2025-04-18 17:37:34,495 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S2R1_qc_violin_after_filter.png
2025-04-18 17:37:34,500 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 17:37:34,668 [INFO] Saved log-normalized data to adata.raw
2025-04-18 17:37:34,674 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 17:37:34,679 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 17:37:34,805 [INFO] Applying log1p transformation.
2025-04-18 17:37:34,969 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 17:37:35,747 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 17:37:35,762 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 17:37:35,767 [INFO] --- Step 6: Scaling Data ---
2025-04-18 17:37:35,771 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 17:37:40,402 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 17:37:40,407 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 17:37:40,412 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 17:37:48,346 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 17:37:48,364 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 17:37:48,369 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 17:37:48,374 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 17:37:57,139 [INFO] --- Step 9: Clustering ---
2025-04-18 17:37:57,144 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 17:39:31,168 [INFO] Found 20 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 17:39:31,173 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 17:39:31,178 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 17:40:11,565 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_umap_clusters_leiden_res0.8.png
2025-04-18 17:40:17,517 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_spatial_clusters_leiden_res0.8.png
2025-04-18 17:40:17,523 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 17:40:17,527 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 17:41:32,972 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 17:41:34,803 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S2R1_rank_genes_clusters_leiden_res0.8.png
2025-04-18 17:41:34,808 [INFO] --- Step 12: Saving Results ---
2025-04-18 17:41:34,818 [INFO] Final QC Summary: {'n_cells': 67052, 'n_genes': 2000, 'median_total_counts': 248.0, 'mean_total_counts': 331.9176330566406, 'median_n_genes_by_counts': 208.0, 'mean_n_genes_by_counts': 249.2720724214043, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 17:41:40,350 [ERROR] Failed to save AnnData object: Can't implicitly convert non-string objects to strings
2025-04-18 17:41:40,356 [INFO] Preprocessing pipeline finished.
2025-04-18 17:43:09,930 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 17:43:09,936 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R1
2025-04-18 17:43:09,940 [INFO] Sample ID set to: CRC_BJM1_S2R1_fix2
2025-04-18 17:43:09,945 [INFO] --- Step 1: Loading Data ---
2025-04-18 17:43:09,950 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cell_feature_matrix.h5
2025-04-18 17:43:10,993 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cells.parquet
2025-04-18 17:43:11,111 [INFO] Initial AnnData object shape: (67645, 5001)
2025-04-18 17:43:11,117 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 17:43:11,121 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 17:43:11,126 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 17:43:11,130 [INFO] Joining metadata from cells parquet file.
2025-04-18 17:43:11,191 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 17:43:11,196 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 17:43:11,206 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide2(0050585)_Region1
2025-04-18 17:43:11,213 [INFO] Found 10 potential core info files.
2025-04-18 17:43:11,268 [INFO] Found 8190 overlapping cells for Core 13 in 13_cells_stats.csv.
2025-04-18 17:43:11,373 [INFO] Found 9085 overlapping cells for Core 14 in 14_cells_stats.csv.
2025-04-18 17:43:11,457 [INFO] Found 2638 overlapping cells for Core 1 in 1_cells_stats.csv.
2025-04-18 17:43:11,510 [INFO] Found 7281 overlapping cells for Core 25 in 25_cells_stats.csv.
2025-04-18 17:43:11,590 [INFO] Found 6403 overlapping cells for Core 26 in 26_cells_stats.csv.
2025-04-18 17:43:11,664 [INFO] Found 3737 overlapping cells for Core 2 in 2_cells_stats.csv.
2025-04-18 17:43:11,722 [INFO] Found 6759 overlapping cells for Core 37 in 37_cells_stats.csv.
2025-04-18 17:43:11,802 [INFO] Found 9320 overlapping cells for Core 38 in 38_cells_stats.csv.
2025-04-18 17:43:11,894 [INFO] Found 6934 overlapping cells for Core 49 in 49_cells_stats.csv.
2025-04-18 17:43:11,971 [INFO] Found 7201 overlapping cells for Core 50 in 50_cells_stats.csv.
2025-04-18 17:43:12,021 [INFO] Assigned Core IDs to 67548/67645 cells.
2025-04-18 17:43:12,028 [INFO] Core value counts:
Core
38      9320
14      9085
13      8190
25      7281
50      7201
49      6934
37      6759
26      6403
2       3737
1       2638
<NA>      97
Name: count, dtype: int64
2025-04-18 17:43:12,032 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 17:43:12,044 [INFO] Identified 0 mitochondrial genes.
2025-04-18 17:43:12,048 [INFO] Identified 1 ribosomal genes.
2025-04-18 17:43:12,053 [INFO] Identified 4 hemoglobin genes.
2025-04-18 17:43:12,281 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 67645, 'n_genes': 5001, 'median_total_counts': 246.0, 'mean_total_counts': 329.0464782714844, 'median_n_genes_by_counts': 206.0, 'mean_n_genes_by_counts': 247.12465075024022, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 17:43:13,614 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S2R1_qc_violin_before_filter.png
2025-04-18 17:43:13,619 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 17:43:13,623 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 17:43:14,061 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 17:43:14,168 [INFO] Cells to remove based on min_genes (3): 208
2025-04-18 17:43:14,185 [INFO] Cells to remove based on min_counts (10): 593
2025-04-18 17:43:14,192 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 17:43:14,400 [INFO] Filtered cells: 593 cells removed based on combined criteria.
2025-04-18 17:43:14,405 [INFO] AnnData shape after QC filtering: (67052, 5000)
2025-04-18 17:43:15,711 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S2R1_qc_violin_after_filter.png
2025-04-18 17:43:15,716 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 17:43:15,891 [INFO] Saved log-normalized data to adata.raw
2025-04-18 17:43:15,896 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 17:43:15,900 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 17:43:16,027 [INFO] Applying log1p transformation.
2025-04-18 17:43:16,106 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 17:43:16,517 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 17:43:16,527 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 17:43:16,529 [INFO] --- Step 6: Scaling Data ---
2025-04-18 17:43:16,531 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 17:43:19,110 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 17:43:19,112 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 17:43:19,114 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 17:43:25,546 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 17:43:25,566 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 17:43:25,571 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 17:43:25,576 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 17:43:32,960 [INFO] --- Step 9: Clustering ---
2025-04-18 17:43:32,965 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 17:44:59,539 [INFO] Found 20 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 17:44:59,546 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 17:44:59,551 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 17:45:39,724 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_umap_clusters_leiden_res0.8.png
2025-04-18 17:45:45,412 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_spatial_clusters_leiden_res0.8.png
2025-04-18 17:45:45,414 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 17:45:45,416 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 17:45:53,168 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 17:45:55,077 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S2R1_rank_genes_clusters_leiden_res0.8.png
2025-04-18 17:45:55,083 [INFO] --- Step 12: Saving Results ---
2025-04-18 17:45:55,094 [INFO] Final QC Summary: {'n_cells': 67052, 'n_genes': 2000, 'median_total_counts': 248.0, 'mean_total_counts': 331.9176330566406, 'median_n_genes_by_counts': 208.0, 'mean_n_genes_by_counts': 249.2720724214043, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 17:46:01,062 [ERROR] Failed to save AnnData object: Can't implicitly convert non-string objects to strings
2025-04-18 17:46:01,071 [INFO] Preprocessing pipeline finished.
2025-04-18 17:54:04,124 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 17:54:04,131 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R1
2025-04-18 17:54:04,136 [INFO] Sample ID set to: CRC_BJM1_S2R1_fix2
2025-04-18 17:54:04,142 [INFO] --- Step 1: Loading Data ---
2025-04-18 17:54:04,147 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cell_feature_matrix.h5
2025-04-18 17:54:04,982 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cells.parquet
2025-04-18 17:54:05,033 [INFO] Initial AnnData object shape: (67645, 5001)
2025-04-18 17:54:05,039 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 17:54:05,046 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 17:54:05,051 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 17:54:05,057 [INFO] Joining metadata from cells parquet file.
2025-04-18 17:54:05,107 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 17:54:05,115 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 17:54:05,125 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide2(0050585)_Region1
2025-04-18 17:54:05,132 [INFO] Found 10 potential core info files.
2025-04-18 17:54:05,180 [INFO] Found 8190 overlapping cells for Core 13 in 13_cells_stats.csv.
2025-04-18 17:54:05,285 [INFO] Found 9085 overlapping cells for Core 14 in 14_cells_stats.csv.
2025-04-18 17:54:05,355 [INFO] Found 2638 overlapping cells for Core 1 in 1_cells_stats.csv.
2025-04-18 17:54:05,398 [INFO] Found 7281 overlapping cells for Core 25 in 25_cells_stats.csv.
2025-04-18 17:54:05,462 [INFO] Found 6403 overlapping cells for Core 26 in 26_cells_stats.csv.
2025-04-18 17:54:05,523 [INFO] Found 3737 overlapping cells for Core 2 in 2_cells_stats.csv.
2025-04-18 17:54:05,570 [INFO] Found 6759 overlapping cells for Core 37 in 37_cells_stats.csv.
2025-04-18 17:54:05,634 [INFO] Found 9320 overlapping cells for Core 38 in 38_cells_stats.csv.
2025-04-18 17:54:05,710 [INFO] Found 6934 overlapping cells for Core 49 in 49_cells_stats.csv.
2025-04-18 17:54:05,773 [INFO] Found 7201 overlapping cells for Core 50 in 50_cells_stats.csv.
2025-04-18 17:54:05,822 [INFO] Assigned Core IDs to 67548/67645 cells.
2025-04-18 17:54:05,829 [INFO] Core value counts:
Core
38      9320
14      9085
13      8190
25      7281
50      7201
49      6934
37      6759
26      6403
2       3737
1       2638
<NA>      97
Name: count, dtype: int64
2025-04-18 17:54:05,835 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 17:54:05,851 [INFO] Identified 0 mitochondrial genes.
2025-04-18 17:54:05,856 [INFO] Identified 1 ribosomal genes.
2025-04-18 17:54:05,862 [INFO] Identified 4 hemoglobin genes.
2025-04-18 17:54:06,093 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 67645, 'n_genes': 5001, 'median_total_counts': 246.0, 'mean_total_counts': 329.0464782714844, 'median_n_genes_by_counts': 206.0, 'mean_n_genes_by_counts': 247.12465075024022, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 17:54:07,499 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S2R1_qc_violin_before_filter.png
2025-04-18 17:54:07,506 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 17:54:07,511 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 17:54:07,951 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 17:54:08,058 [INFO] Cells to remove based on min_genes (3): 208
2025-04-18 17:54:08,074 [INFO] Cells to remove based on min_counts (10): 593
2025-04-18 17:54:08,082 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 17:54:08,240 [INFO] Filtered cells: 593 cells removed based on combined criteria.
2025-04-18 17:54:08,246 [INFO] AnnData shape after QC filtering: (67052, 5000)
2025-04-18 17:54:09,550 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S2R1_qc_violin_after_filter.png
2025-04-18 17:54:09,556 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 17:54:09,724 [INFO] Saved log-normalized data to adata.raw
2025-04-18 17:54:09,730 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 17:54:09,736 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 17:54:09,845 [INFO] Applying log1p transformation.
2025-04-18 17:54:09,931 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 17:54:10,267 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 17:54:10,284 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 17:54:10,291 [INFO] --- Step 6: Scaling Data ---
2025-04-18 17:54:10,296 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 17:54:12,820 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 17:54:12,828 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 17:54:12,834 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 17:54:19,348 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 17:54:19,364 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 17:54:19,370 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 17:54:19,375 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 17:54:26,587 [INFO] --- Step 9: Clustering ---
2025-04-18 17:54:26,593 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 17:55:52,920 [INFO] Found 20 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 17:55:52,930 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 17:55:52,935 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 17:56:32,636 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_umap_clusters_leiden_res0.8.png
2025-04-18 17:56:38,264 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_spatial_clusters_leiden_res0.8.png
2025-04-18 17:56:38,270 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 17:56:38,276 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 17:56:43,755 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 17:56:45,584 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S2R1_rank_genes_clusters_leiden_res0.8.png
2025-04-18 17:56:45,590 [INFO] --- Step 12: Saving Results ---
2025-04-18 17:56:45,602 [INFO] Final QC Summary: {'n_cells': 67052, 'n_genes': 2000, 'median_total_counts': 248.0, 'mean_total_counts': 331.9176330566406, 'median_n_genes_by_counts': 208.0, 'mean_n_genes_by_counts': 249.2720724214043, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 17:56:45,608 [INFO] Converting potentially problematic column 'Transcripts_core' to string type.
2025-04-18 17:56:45,642 [INFO] Converting potentially problematic column 'Area (µm^2)_core' to string type.
2025-04-18 17:56:57,892 [ERROR] Failed to save AnnData object: No method registered for writing <class 'tuple'> into <class 'h5py._hl.group.Group'>
2025-04-18 17:56:57,898 [INFO] Preprocessing pipeline finished.
2025-04-18 18:02:05,016 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 18:02:05,024 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R1
2025-04-18 18:02:05,032 [INFO] Sample ID set to: CRC_BJM1_S2R1_fix2
2025-04-18 18:02:05,039 [INFO] --- Step 1: Loading Data ---
2025-04-18 18:02:05,049 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cell_feature_matrix.h5
2025-04-18 18:02:06,099 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cells.parquet
2025-04-18 18:02:06,193 [INFO] Initial AnnData object shape: (67645, 5001)
2025-04-18 18:02:06,200 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 18:02:06,208 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 18:02:06,216 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 18:02:06,226 [INFO] Joining metadata from cells parquet file.
2025-04-18 18:02:06,293 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 18:02:06,300 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 18:02:06,311 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide2(0050585)_Region1
2025-04-18 18:02:06,320 [INFO] Found 10 potential core info files.
2025-04-18 18:02:06,379 [INFO] Found 8190 overlapping cells for Core 13 in 13_cells_stats.csv.
2025-04-18 18:02:06,508 [INFO] Found 9085 overlapping cells for Core 14 in 14_cells_stats.csv.
2025-04-18 18:02:06,595 [INFO] Found 2638 overlapping cells for Core 1 in 1_cells_stats.csv.
2025-04-18 18:02:06,649 [INFO] Found 7281 overlapping cells for Core 25 in 25_cells_stats.csv.
2025-04-18 18:02:06,731 [INFO] Found 6403 overlapping cells for Core 26 in 26_cells_stats.csv.
2025-04-18 18:02:06,807 [INFO] Found 3737 overlapping cells for Core 2 in 2_cells_stats.csv.
2025-04-18 18:02:06,868 [INFO] Found 6759 overlapping cells for Core 37 in 37_cells_stats.csv.
2025-04-18 18:02:06,951 [INFO] Found 9320 overlapping cells for Core 38 in 38_cells_stats.csv.
2025-04-18 18:02:07,046 [INFO] Found 6934 overlapping cells for Core 49 in 49_cells_stats.csv.
2025-04-18 18:02:07,126 [INFO] Found 7201 overlapping cells for Core 50 in 50_cells_stats.csv.
2025-04-18 18:02:07,190 [INFO] Assigned Core IDs to 67548/67645 cells.
2025-04-18 18:02:07,199 [INFO] Core value counts:
Core
38      9320
14      9085
13      8190
25      7281
50      7201
49      6934
37      6759
26      6403
2       3737
1       2638
<NA>      97
Name: count, dtype: int64
2025-04-18 18:02:07,208 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 18:02:07,227 [INFO] Identified 0 mitochondrial genes.
2025-04-18 18:02:07,236 [INFO] Identified 1 ribosomal genes.
2025-04-18 18:02:07,253 [INFO] Identified 4 hemoglobin genes.
2025-04-18 18:02:07,573 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 67645, 'n_genes': 5001, 'median_total_counts': 246.0, 'mean_total_counts': 329.0464782714844, 'median_n_genes_by_counts': 206.0, 'mean_n_genes_by_counts': 247.12465075024022, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:02:08,958 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S2R1_qc_violin_before_filter.png
2025-04-18 18:02:08,965 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 18:02:08,970 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 18:02:09,408 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 18:02:09,516 [INFO] Cells to remove based on min_genes (3): 208
2025-04-18 18:02:09,533 [INFO] Cells to remove based on min_counts (10): 593
2025-04-18 18:02:09,540 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 18:02:09,711 [INFO] Filtered cells: 593 cells removed based on combined criteria.
2025-04-18 18:02:09,717 [INFO] AnnData shape after QC filtering: (67052, 5000)
2025-04-18 18:02:11,008 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S2R1_qc_violin_after_filter.png
2025-04-18 18:02:11,014 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 18:02:11,190 [INFO] Saved log-normalized data to adata.raw
2025-04-18 18:02:11,195 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 18:02:11,200 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 18:02:11,314 [INFO] Applying log1p transformation.
2025-04-18 18:02:11,395 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 18:02:11,801 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 18:02:11,814 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 18:02:11,819 [INFO] --- Step 6: Scaling Data ---
2025-04-18 18:02:11,825 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 18:02:14,339 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 18:02:14,346 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 18:02:14,351 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 18:02:20,802 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 18:02:20,821 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 18:02:20,826 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 18:02:20,831 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 18:02:27,891 [INFO] --- Step 9: Clustering ---
2025-04-18 18:02:27,897 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 18:03:53,383 [INFO] Found 20 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 18:03:53,393 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 18:03:53,398 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 18:04:33,760 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_umap_clusters_leiden_res0.8.png
2025-04-18 18:04:39,423 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_spatial_clusters_leiden_res0.8.png
2025-04-18 18:04:39,429 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 18:04:39,434 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 18:05:19,441 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 18:05:21,255 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S2R1_rank_genes_clusters_leiden_res0.8.png
2025-04-18 18:05:21,261 [INFO] --- Step 12: Saving Results ---
2025-04-18 18:05:21,272 [INFO] Final QC Summary: {'n_cells': 67052, 'n_genes': 2000, 'median_total_counts': 248.0, 'mean_total_counts': 331.9176330566406, 'median_n_genes_by_counts': 208.0, 'mean_n_genes_by_counts': 249.2720724214043, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:05:21,278 [INFO] Converting potentially problematic column 'Transcripts_core' to string type.
2025-04-18 18:05:21,312 [INFO] Converting potentially problematic column 'Area (µm^2)_core' to string type.
2025-04-18 18:05:33,549 [ERROR] Failed to save AnnData object: No method registered for writing <class 'tuple'> into <class 'h5py._hl.group.Group'>
2025-04-18 18:05:33,557 [INFO] Preprocessing pipeline finished.
2025-04-18 18:19:44,464 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 18:19:44,472 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R1_final
2025-04-18 18:19:44,479 [INFO] Sample ID set to: CRC_BJM1_S2R1_fix3
2025-04-18 18:19:44,492 [INFO] --- Step 1: Loading Data ---
2025-04-18 18:19:44,501 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cell_feature_matrix.h5
2025-04-18 18:19:45,560 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cells.parquet
2025-04-18 18:19:45,640 [INFO] Initial AnnData object shape: (67645, 5001)
2025-04-18 18:19:45,647 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 18:19:45,653 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 18:19:45,660 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 18:23:26,086 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 18:23:26,097 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R1_final
2025-04-18 18:23:26,105 [INFO] Sample ID set to: CRC_BJM1_S2R1_fix3
2025-04-18 18:23:26,117 [INFO] --- Step 1: Loading Data ---
2025-04-18 18:23:26,127 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cell_feature_matrix.h5
2025-04-18 18:23:27,179 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cells.parquet
2025-04-18 18:23:27,255 [INFO] Initial AnnData object shape: (67645, 5001)
2025-04-18 18:23:27,263 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 18:23:27,269 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 18:23:27,276 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 18:23:27,283 [INFO] Joining metadata from cells parquet file.
2025-04-18 18:23:27,347 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 18:23:27,355 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 18:23:27,366 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide2(0050585)_Region1
2025-04-18 18:23:27,376 [INFO] Found 10 potential core info files.
2025-04-18 18:23:27,439 [INFO] Found 8190 overlapping cells for Core 13 in 13_cells_stats.csv.
2025-04-18 18:23:27,581 [INFO] Found 9085 overlapping cells for Core 14 in 14_cells_stats.csv.
2025-04-18 18:23:27,676 [INFO] Found 2638 overlapping cells for Core 1 in 1_cells_stats.csv.
2025-04-18 18:23:27,735 [INFO] Found 7281 overlapping cells for Core 25 in 25_cells_stats.csv.
2025-04-18 18:23:27,823 [INFO] Found 6403 overlapping cells for Core 26 in 26_cells_stats.csv.
2025-04-18 18:23:27,906 [INFO] Found 3737 overlapping cells for Core 2 in 2_cells_stats.csv.
2025-04-18 18:23:27,971 [INFO] Found 6759 overlapping cells for Core 37 in 37_cells_stats.csv.
2025-04-18 18:23:28,060 [INFO] Found 9320 overlapping cells for Core 38 in 38_cells_stats.csv.
2025-04-18 18:23:28,162 [INFO] Found 6934 overlapping cells for Core 49 in 49_cells_stats.csv.
2025-04-18 18:23:28,248 [INFO] Found 7201 overlapping cells for Core 50 in 50_cells_stats.csv.
2025-04-18 18:23:28,308 [INFO] Assigned Core IDs to 67548/67645 cells.
2025-04-18 18:23:28,317 [INFO] Core value counts:
Core
38      9320
14      9085
13      8190
25      7281
50      7201
49      6934
37      6759
26      6403
2       3737
1       2638
<NA>      97
Name: count, dtype: int64
2025-04-18 18:23:28,327 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-18 18:23:28,334 [INFO] Converting column 'Transcripts_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:23:28,368 [INFO] Successfully converted 'Transcripts_core' to string.
2025-04-18 18:23:28,376 [INFO] Converting column 'Area (µm^2)_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:23:28,428 [INFO] Successfully converted 'Area (µm^2)_core' to string.
2025-04-18 18:23:28,436 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 18:23:28,456 [INFO] Identified 0 mitochondrial genes.
2025-04-18 18:23:28,468 [INFO] Identified 1 ribosomal genes.
2025-04-18 18:23:28,479 [INFO] Identified 4 hemoglobin genes.
2025-04-18 18:23:28,786 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 67645, 'n_genes': 5001, 'median_total_counts': 246.0, 'mean_total_counts': 329.0464782714844, 'median_n_genes_by_counts': 206.0, 'mean_n_genes_by_counts': 247.12465075024022, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:23:30,255 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S2R1_final_qc_violin_before_filter.png
2025-04-18 18:23:30,263 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 18:23:30,270 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 18:23:30,706 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 18:23:30,812 [INFO] Cells to remove based on min_genes (3): 208
2025-04-18 18:23:30,830 [INFO] Cells to remove based on min_counts (10): 593
2025-04-18 18:23:30,840 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 18:23:31,009 [INFO] Filtered cells: 593 cells removed based on combined criteria.
2025-04-18 18:23:31,016 [INFO] AnnData shape after QC filtering: (67052, 5000)
2025-04-18 18:23:32,365 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S2R1_final_qc_violin_after_filter.png
2025-04-18 18:23:32,372 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 18:23:32,546 [INFO] Saved log-normalized data to adata.raw
2025-04-18 18:23:32,553 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 18:23:32,560 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 18:23:32,674 [INFO] Applying log1p transformation.
2025-04-18 18:23:32,755 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 18:23:33,090 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 18:23:33,102 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 18:23:33,109 [INFO] --- Step 6: Scaling Data ---
2025-04-18 18:23:33,116 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 18:23:35,551 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 18:23:35,558 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 18:23:35,565 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 18:23:41,203 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 18:23:41,222 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 18:23:41,226 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 18:23:41,230 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 18:23:48,314 [INFO] --- Step 9: Clustering ---
2025-04-18 18:23:48,323 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 18:25:13,189 [INFO] Found 20 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 18:25:13,197 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 18:25:13,203 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 18:25:52,435 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_final_umap_clusters_leiden_res0.8.png
2025-04-18 18:25:58,104 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_final_spatial_clusters_leiden_res0.8.png
2025-04-18 18:25:58,112 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 18:25:58,119 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 18:27:11,838 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 18:27:13,670 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S2R1_final_rank_genes_clusters_leiden_res0.8.png
2025-04-18 18:27:13,677 [INFO] --- Step 12: Saving Results ---
2025-04-18 18:27:13,692 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 67052, 'n_genes': 2000, 'median_total_counts': 248.0, 'mean_total_counts': 331.9176330566406, 'median_n_genes_by_counts': 208.0, 'mean_n_genes_by_counts': 249.2720724214043, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:27:13,699 [INFO] Saving provenance information to: processed_xenium_CRC_BJM1_S2R1_final_provenance.json
2025-04-18 18:27:13,711 [INFO] Provenance data saved successfully.
2025-04-18 18:27:13,718 [INFO] Attempting to save final AnnData object to: processed_xenium_CRC_BJM1_S2R1_final_processed.h5ad
2025-04-18 18:27:25,783 [INFO] Successfully saved processed AnnData object to: processed_xenium_CRC_BJM1_S2R1_final_processed.h5ad
2025-04-18 18:27:25,792 [INFO] Preprocessing pipeline finished.
2025-04-18 18:37:11,119 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 18:37:11,130 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S1R1
2025-04-18 18:37:11,139 [INFO] Sample ID set to: CRC_BJM1_S1R1
2025-04-18 18:37:11,151 [INFO] --- Step 1: Loading Data ---
2025-04-18 18:37:11,161 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_1__20250205__113422/cell_feature_matrix.h5
2025-04-18 18:37:12,137 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_1__20250205__113422/cells.parquet
2025-04-18 18:37:12,363 [INFO] Initial AnnData object shape: (64113, 5001)
2025-04-18 18:37:12,371 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 18:37:12,382 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 18:37:12,395 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 18:37:12,404 [INFO] Joining metadata from cells parquet file.
2025-04-18 18:37:12,470 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 18:37:12,479 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 18:37:12,492 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide1(0050568)_Region1
2025-04-18 18:37:12,503 [INFO] Found 10 potential core info files.
2025-04-18 18:37:12,575 [INFO] Found 5830 overlapping cells for Core 19 in 19_cells_stats.csv.
2025-04-18 18:37:12,716 [INFO] Found 6764 overlapping cells for Core 20 in 20_cells_stats.csv.
2025-04-18 18:37:12,824 [INFO] Found 6227 overlapping cells for Core 31 in 31_cells_stats.csv.
2025-04-18 18:37:12,916 [INFO] Found 7876 overlapping cells for Core 32 in 32_cells_stats.csv.
2025-04-18 18:37:13,005 [INFO] Found 4478 overlapping cells for Core 43 in 43_cells_stats.csv.
2025-04-18 18:37:13,083 [INFO] Found 8254 overlapping cells for Core 44 in 44_cells_stats.csv.
2025-04-18 18:37:13,177 [INFO] Found 5906 overlapping cells for Core 55 in 55_cells_stats.csv.
2025-04-18 18:37:13,258 [INFO] Found 6511 overlapping cells for Core 56 in 56_cells_stats.csv.
2025-04-18 18:37:13,342 [INFO] Found 5531 overlapping cells for Core 7 in 7_cells_stats.csv.
2025-04-18 18:37:13,417 [INFO] Found 6581 overlapping cells for Core 8 in 8_cells_stats.csv.
2025-04-18 18:37:13,478 [INFO] Assigned Core IDs to 63958/64113 cells.
2025-04-18 18:37:13,488 [INFO] Core value counts:
Core
44      8254
32      7876
20      6764
8       6581
56      6511
31      6227
55      5906
19      5830
7       5531
43      4478
<NA>     155
Name: count, dtype: int64
2025-04-18 18:37:13,496 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-18 18:37:13,504 [INFO] Converting column 'Transcripts_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:37:13,540 [INFO] Successfully converted 'Transcripts_core' to string.
2025-04-18 18:37:13,548 [INFO] Converting column 'Area (µm^2)_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:37:13,596 [INFO] Successfully converted 'Area (µm^2)_core' to string.
2025-04-18 18:37:13,604 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 18:37:13,628 [INFO] Identified 0 mitochondrial genes.
2025-04-18 18:37:13,637 [INFO] Identified 1 ribosomal genes.
2025-04-18 18:37:13,648 [INFO] Identified 4 hemoglobin genes.
2025-04-18 18:37:13,922 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 64113, 'n_genes': 5001, 'median_total_counts': 210.0, 'mean_total_counts': 280.7059326171875, 'median_n_genes_by_counts': 177.0, 'mean_n_genes_by_counts': 212.2728775755307, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:37:15,297 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S1R1_qc_violin_before_filter.png
2025-04-18 18:37:15,305 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 18:37:15,311 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 18:37:15,673 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 18:37:15,763 [INFO] Cells to remove based on min_genes (3): 328
2025-04-18 18:37:15,780 [INFO] Cells to remove based on min_counts (10): 994
2025-04-18 18:37:15,790 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 18:37:15,952 [INFO] Filtered cells: 994 cells removed based on combined criteria.
2025-04-18 18:37:15,960 [INFO] AnnData shape after QC filtering: (63119, 5000)
2025-04-18 18:37:17,220 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S1R1_qc_violin_after_filter.png
2025-04-18 18:37:17,229 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 18:37:17,378 [INFO] Saved log-normalized data to adata.raw
2025-04-18 18:37:17,388 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 18:37:17,397 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 18:37:17,499 [INFO] Applying log1p transformation.
2025-04-18 18:37:17,566 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 18:37:17,860 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 18:37:17,874 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 18:37:17,881 [INFO] --- Step 6: Scaling Data ---
2025-04-18 18:37:17,888 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 18:37:20,025 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 18:37:20,032 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 18:37:20,039 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 18:37:26,004 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 18:37:26,019 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 18:37:26,024 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 18:37:26,029 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 18:37:32,914 [INFO] --- Step 9: Clustering ---
2025-04-18 18:37:32,922 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 18:38:11,360 [INFO] Found 22 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 18:38:11,368 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 18:38:11,378 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 18:38:47,859 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S1R1_umap_clusters_leiden_res0.8.png
2025-04-18 18:38:53,329 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S1R1_spatial_clusters_leiden_res0.8.png
2025-04-18 18:38:53,337 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 18:38:53,343 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 18:39:29,073 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 18:39:31,130 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S1R1_rank_genes_clusters_leiden_res0.8.png
2025-04-18 18:39:31,137 [INFO] --- Step 12: Saving Results ---
2025-04-18 18:39:31,150 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 63119, 'n_genes': 2000, 'median_total_counts': 214.0, 'mean_total_counts': 285.0565490722656, 'median_n_genes_by_counts': 180.0, 'mean_n_genes_by_counts': 215.54785405345459, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:39:31,157 [INFO] Saving provenance information to: processed_xenium_CRC_BJM1_S1R1_provenance.json
2025-04-18 18:39:31,168 [INFO] Provenance data saved successfully.
2025-04-18 18:39:31,176 [INFO] Attempting to save final AnnData object to: processed_xenium_CRC_BJM1_S1R1_processed.h5ad
2025-04-18 18:39:41,241 [INFO] Successfully saved processed AnnData object to: processed_xenium_CRC_BJM1_S1R1_processed.h5ad
2025-04-18 18:39:41,250 [INFO] Preprocessing pipeline finished.
2025-04-18 18:39:41,263 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 18:39:41,270 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S1R2
2025-04-18 18:39:41,277 [INFO] Sample ID set to: CRC_BJM1_S1R2
2025-04-18 18:39:41,284 [INFO] --- Step 1: Loading Data ---
2025-04-18 18:39:41,290 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_2__20250205__113422/cell_feature_matrix.h5
2025-04-18 18:39:42,050 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_2__20250205__113422/cells.parquet
2025-04-18 18:39:42,147 [INFO] Initial AnnData object shape: (45469, 5001)
2025-04-18 18:39:42,155 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 18:39:42,165 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 18:39:42,173 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 18:39:42,181 [INFO] Joining metadata from cells parquet file.
2025-04-18 18:39:42,235 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 18:39:42,244 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 18:39:42,257 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide1(0050568)_Region2
2025-04-18 18:39:42,268 [INFO] Found 9 potential core info files.
2025-04-18 18:39:42,335 [INFO] Found 4759 overlapping cells for Core 103 in 103_cells_stats.csv.
2025-04-18 18:39:42,455 [INFO] Found 3904 overlapping cells for Core 104 in 104_cells_stats.csv.
2025-04-18 18:39:42,538 [INFO] Found 5454 overlapping cells for Core 115 in 115_cells_stats.csv.
2025-04-18 18:39:42,614 [INFO] Found 2786 overlapping cells for Core 116 in 116_cells_stats.csv.
2025-04-18 18:39:42,673 [INFO] Found 4015 overlapping cells for Core 67 in 67_cells_stats.csv.
2025-04-18 18:39:42,738 [INFO] Found 4408 overlapping cells for Core 68 in 68_cells_stats.csv.
2025-04-18 18:39:42,809 [INFO] Found 6844 overlapping cells for Core 80 in 80_cells_stats.csv.
2025-04-18 18:39:42,900 [INFO] Found 6838 overlapping cells for Core 91 in 91_cells_stats.csv.
2025-04-18 18:39:42,991 [INFO] Found 6170 overlapping cells for Core 92 in 92_cells_stats.csv.
2025-04-18 18:39:43,060 [INFO] Assigned Core IDs to 45178/45469 cells.
2025-04-18 18:39:43,069 [INFO] Core value counts:
Core
80      6844
91      6838
92      6170
115     5454
103     4759
68      4408
67      4015
104     3904
116     2786
<NA>     291
Name: count, dtype: int64
2025-04-18 18:39:43,077 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-18 18:39:43,084 [INFO] Converting column 'Transcripts_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:39:43,116 [INFO] Successfully converted 'Transcripts_core' to string.
2025-04-18 18:39:43,124 [INFO] Converting column 'Area (µm^2)_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:39:43,168 [INFO] Successfully converted 'Area (µm^2)_core' to string.
2025-04-18 18:39:43,176 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 18:39:43,197 [INFO] Identified 0 mitochondrial genes.
2025-04-18 18:39:43,209 [INFO] Identified 1 ribosomal genes.
2025-04-18 18:39:43,219 [INFO] Identified 4 hemoglobin genes.
2025-04-18 18:39:43,443 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 45469, 'n_genes': 5001, 'median_total_counts': 225.0, 'mean_total_counts': 310.5305480957031, 'median_n_genes_by_counts': 188.0, 'mean_n_genes_by_counts': 229.2965536959247, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:39:44,669 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S1R2_qc_violin_before_filter.png
2025-04-18 18:39:44,676 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 18:39:44,683 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 18:39:44,962 [INFO] Filtered genes: 3 genes removed (< 3 cells).
2025-04-18 18:39:45,026 [INFO] Cells to remove based on min_genes (3): 235
2025-04-18 18:39:45,042 [INFO] Cells to remove based on min_counts (10): 648
2025-04-18 18:39:45,052 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 18:39:45,148 [INFO] Filtered cells: 648 cells removed based on combined criteria.
2025-04-18 18:39:45,155 [INFO] AnnData shape after QC filtering: (44821, 4998)
2025-04-18 18:39:46,218 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S1R2_qc_violin_after_filter.png
2025-04-18 18:39:46,225 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 18:39:46,335 [INFO] Saved log-normalized data to adata.raw
2025-04-18 18:39:46,342 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 18:39:46,349 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 18:39:46,411 [INFO] Applying log1p transformation.
2025-04-18 18:39:46,464 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 18:39:46,691 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 18:39:46,707 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 18:39:46,714 [INFO] --- Step 6: Scaling Data ---
2025-04-18 18:39:46,721 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 18:39:48,317 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 18:39:48,324 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 18:39:48,331 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 18:39:52,673 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 18:39:52,689 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 18:39:52,695 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 18:39:52,701 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 18:39:57,800 [INFO] --- Step 9: Clustering ---
2025-04-18 18:39:57,808 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 18:40:30,089 [INFO] Found 21 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 18:40:30,098 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 18:40:30,105 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 18:40:54,079 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S1R2_umap_clusters_leiden_res0.8.png
2025-04-18 18:40:57,650 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S1R2_spatial_clusters_leiden_res0.8.png
2025-04-18 18:40:57,657 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 18:40:57,667 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 18:41:46,762 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 18:41:48,663 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S1R2_rank_genes_clusters_leiden_res0.8.png
2025-04-18 18:41:48,670 [INFO] --- Step 12: Saving Results ---
2025-04-18 18:41:48,683 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 44821, 'n_genes': 2000, 'median_total_counts': 229.0, 'mean_total_counts': 314.96087646484375, 'median_n_genes_by_counts': 190.0, 'mean_n_genes_by_counts': 232.5541821913835, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:41:48,690 [INFO] Saving provenance information to: processed_xenium_CRC_BJM1_S1R2_provenance.json
2025-04-18 18:41:48,701 [INFO] Provenance data saved successfully.
2025-04-18 18:41:48,709 [INFO] Attempting to save final AnnData object to: processed_xenium_CRC_BJM1_S1R2_processed.h5ad
2025-04-18 18:41:56,136 [INFO] Successfully saved processed AnnData object to: processed_xenium_CRC_BJM1_S1R2_processed.h5ad
2025-04-18 18:41:56,143 [INFO] Preprocessing pipeline finished.
2025-04-18 18:41:56,160 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 18:41:56,167 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S1R3
2025-04-18 18:41:56,174 [INFO] Sample ID set to: CRC_BJM1_S1R3
2025-04-18 18:41:56,181 [INFO] --- Step 1: Loading Data ---
2025-04-18 18:41:56,188 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_3__20250205__113422/cell_feature_matrix.h5
2025-04-18 18:41:57,806 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_3__20250205__113422/cells.parquet
2025-04-18 18:41:57,916 [INFO] Initial AnnData object shape: (83896, 5001)
2025-04-18 18:41:57,926 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 18:41:57,936 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 18:41:57,943 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 18:41:57,951 [INFO] Joining metadata from cells parquet file.
2025-04-18 18:41:58,038 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 18:41:58,046 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 18:41:58,059 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide1(0050568)_Region3
2025-04-18 18:41:58,085 [INFO] Found 10 potential core info files.
2025-04-18 18:41:58,188 [INFO] Found 7299 overlapping cells for Core 10 in 10_cells_stats.csv.
2025-04-18 18:41:58,349 [INFO] Found 8917 overlapping cells for Core 21 in 21_cells_stats.csv.
2025-04-18 18:41:58,472 [INFO] Found 5861 overlapping cells for Core 22 in 22_cells_stats.csv.
2025-04-18 18:41:58,589 [INFO] Found 7677 overlapping cells for Core 33 in 33_cells_stats.csv.
2025-04-18 18:41:58,698 [INFO] Found 7180 overlapping cells for Core 34 in 34_cells_stats.csv.
2025-04-18 18:41:58,808 [INFO] Found 11855 overlapping cells for Core 45 in 45_cells_stats.csv.
2025-04-18 18:41:58,952 [INFO] Found 10174 overlapping cells for Core 46 in 46_cells_stats.csv.
2025-04-18 18:41:59,072 [INFO] Found 6903 overlapping cells for Core 57 in 57_cells_stats.csv.
2025-04-18 18:41:59,175 [INFO] Found 11177 overlapping cells for Core 58 in 58_cells_stats.csv.
2025-04-18 18:41:59,282 [INFO] Found 5772 overlapping cells for Core 9 in 9_cells_stats.csv.
2025-04-18 18:41:59,326 [INFO] Assigned Core IDs to 82815/83896 cells.
2025-04-18 18:41:59,335 [INFO] Core value counts:
Core
45      11855
58      11177
46      10174
21       8917
33       7677
10       7299
34       7180
57       6903
22       5861
9        5772
<NA>     1081
Name: count, dtype: int64
2025-04-18 18:41:59,342 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-18 18:41:59,349 [INFO] Converting column 'Transcripts_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:41:59,387 [INFO] Successfully converted 'Transcripts_core' to string.
2025-04-18 18:41:59,394 [INFO] Converting column 'Area (µm^2)_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:41:59,448 [INFO] Successfully converted 'Area (µm^2)_core' to string.
2025-04-18 18:41:59,455 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 18:41:59,475 [INFO] Identified 0 mitochondrial genes.
2025-04-18 18:41:59,483 [INFO] Identified 1 ribosomal genes.
2025-04-18 18:41:59,490 [INFO] Identified 4 hemoglobin genes.
2025-04-18 18:41:59,875 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 83896, 'n_genes': 5001, 'median_total_counts': 384.0, 'mean_total_counts': 522.6996459960938, 'median_n_genes_by_counts': 298.0, 'mean_n_genes_by_counts': 349.22993944884144, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:42:01,519 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S1R3_qc_violin_before_filter.png
2025-04-18 18:42:01,527 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 18:42:01,534 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 18:42:02,413 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 18:42:02,626 [INFO] Cells to remove based on min_genes (3): 273
2025-04-18 18:42:02,651 [INFO] Cells to remove based on min_counts (10): 988
2025-04-18 18:42:02,661 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 18:42:03,088 [INFO] Filtered cells: 988 cells removed based on combined criteria.
2025-04-18 18:42:03,095 [INFO] AnnData shape after QC filtering: (82908, 5000)
2025-04-18 18:42:04,577 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S1R3_qc_violin_after_filter.png
2025-04-18 18:42:04,584 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 18:42:04,928 [INFO] Saved log-normalized data to adata.raw
2025-04-18 18:42:04,935 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 18:42:04,942 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 18:42:05,155 [INFO] Applying log1p transformation.
2025-04-18 18:42:05,290 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 18:42:05,937 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 18:42:05,949 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 18:42:05,955 [INFO] --- Step 6: Scaling Data ---
2025-04-18 18:42:05,960 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 18:42:16,391 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 18:42:16,399 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 18:42:16,407 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 18:42:28,765 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 18:42:28,782 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 18:42:28,789 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 18:42:28,796 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 18:42:37,133 [INFO] --- Step 9: Clustering ---
2025-04-18 18:42:37,138 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 18:43:44,774 [INFO] Found 17 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 18:43:44,781 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 18:43:44,789 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 18:44:33,029 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S1R3_umap_clusters_leiden_res0.8.png
2025-04-18 18:44:39,906 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S1R3_spatial_clusters_leiden_res0.8.png
2025-04-18 18:44:39,914 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 18:44:39,921 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 18:45:28,415 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 18:45:29,976 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S1R3_rank_genes_clusters_leiden_res0.8.png
2025-04-18 18:45:29,983 [INFO] --- Step 12: Saving Results ---
2025-04-18 18:45:29,997 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 82908, 'n_genes': 2000, 'median_total_counts': 390.0, 'mean_total_counts': 528.8719482421875, 'median_n_genes_by_counts': 303.0, 'mean_n_genes_by_counts': 353.3376393110436, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:45:30,004 [INFO] Saving provenance information to: processed_xenium_CRC_BJM1_S1R3_provenance.json
2025-04-18 18:45:30,014 [INFO] Provenance data saved successfully.
2025-04-18 18:45:30,021 [INFO] Attempting to save final AnnData object to: processed_xenium_CRC_BJM1_S1R3_processed.h5ad
2025-04-18 18:45:47,569 [INFO] Successfully saved processed AnnData object to: processed_xenium_CRC_BJM1_S1R3_processed.h5ad
2025-04-18 18:45:47,578 [INFO] Preprocessing pipeline finished.
2025-04-18 18:45:47,593 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 18:45:47,601 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S1R4
2025-04-18 18:45:47,608 [INFO] Sample ID set to: CRC_BJM1_S1R4
2025-04-18 18:45:47,615 [INFO] --- Step 1: Loading Data ---
2025-04-18 18:45:47,622 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_4__20250205__113422/cell_feature_matrix.h5
2025-04-18 18:45:49,105 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_4__20250205__113422/cells.parquet
2025-04-18 18:45:49,219 [INFO] Initial AnnData object shape: (80263, 5001)
2025-04-18 18:45:49,227 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 18:45:49,234 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 18:45:49,246 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 18:45:49,254 [INFO] Joining metadata from cells parquet file.
2025-04-18 18:45:49,330 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 18:45:49,338 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 18:45:49,352 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide1(0050568)_Region4
2025-04-18 18:45:49,375 [INFO] Found 10 potential core info files.
2025-04-18 18:45:49,473 [INFO] Found 6561 overlapping cells for Core 105 in 105_cells_stats.csv.
2025-04-18 18:45:49,640 [INFO] Found 8411 overlapping cells for Core 106 in 106_cells_stats.csv.
2025-04-18 18:45:49,763 [INFO] Found 4917 overlapping cells for Core 117 in 117_cells_stats.csv.
2025-04-18 18:45:49,847 [INFO] Found 4866 overlapping cells for Core 118 in 118_cells_stats.csv.
2025-04-18 18:45:49,944 [INFO] Found 6531 overlapping cells for Core 69 in 69_cells_stats.csv.
2025-04-18 18:45:50,051 [INFO] Found 12331 overlapping cells for Core 70 in 70_cells_stats.csv.
2025-04-18 18:45:50,198 [INFO] Found 9218 overlapping cells for Core 81 in 81_cells_stats.csv.
2025-04-18 18:45:50,306 [INFO] Found 6872 overlapping cells for Core 82 in 82_cells_stats.csv.
2025-04-18 18:45:50,430 [INFO] Found 12419 overlapping cells for Core 93 in 93_cells_stats.csv.
2025-04-18 18:45:50,551 [INFO] Found 7891 overlapping cells for Core 94 in 94_cells_stats.csv.
2025-04-18 18:45:50,606 [INFO] Assigned Core IDs to 80017/80263 cells.
2025-04-18 18:45:50,616 [INFO] Core value counts:
Core
93      12419
70      12331
81       9218
106      8411
94       7891
82       6872
105      6561
69       6531
117      4917
118      4866
<NA>      246
Name: count, dtype: int64
2025-04-18 18:45:50,623 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-18 18:45:50,629 [INFO] Converting column 'Transcripts_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:45:50,668 [INFO] Successfully converted 'Transcripts_core' to string.
2025-04-18 18:45:50,675 [INFO] Converting column 'Area (µm^2)_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:45:50,726 [INFO] Successfully converted 'Area (µm^2)_core' to string.
2025-04-18 18:45:50,733 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 18:45:50,754 [INFO] Identified 0 mitochondrial genes.
2025-04-18 18:45:50,761 [INFO] Identified 1 ribosomal genes.
2025-04-18 18:45:50,768 [INFO] Identified 4 hemoglobin genes.
2025-04-18 18:45:51,125 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 80263, 'n_genes': 5001, 'median_total_counts': 372.0, 'mean_total_counts': 506.8614807128906, 'median_n_genes_by_counts': 285.0, 'mean_n_genes_by_counts': 334.7989110798251, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:45:52,790 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S1R4_qc_violin_before_filter.png
2025-04-18 18:45:52,797 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 18:45:52,806 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 18:45:53,534 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 18:45:53,700 [INFO] Cells to remove based on min_genes (3): 249
2025-04-18 18:45:53,722 [INFO] Cells to remove based on min_counts (10): 1123
2025-04-18 18:45:53,733 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 18:45:54,086 [INFO] Filtered cells: 1123 cells removed based on combined criteria.
2025-04-18 18:45:54,094 [INFO] AnnData shape after QC filtering: (79140, 5000)
2025-04-18 18:45:55,537 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S1R4_qc_violin_after_filter.png
2025-04-18 18:45:55,546 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 18:45:55,832 [INFO] Saved log-normalized data to adata.raw
2025-04-18 18:45:55,840 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 18:45:55,847 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 18:45:56,040 [INFO] Applying log1p transformation.
2025-04-18 18:45:56,163 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 18:45:56,768 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 18:45:56,784 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 18:45:56,789 [INFO] --- Step 6: Scaling Data ---
2025-04-18 18:45:56,794 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 18:46:00,246 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 18:46:00,254 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 18:46:00,261 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 18:46:06,573 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 18:46:06,590 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 18:46:06,597 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 18:46:06,604 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 18:46:14,922 [INFO] --- Step 9: Clustering ---
2025-04-18 18:46:14,929 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 18:47:35,239 [INFO] Found 16 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 18:47:35,255 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 18:47:35,264 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 18:48:21,247 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S1R4_umap_clusters_leiden_res0.8.png
2025-04-18 18:48:28,141 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S1R4_spatial_clusters_leiden_res0.8.png
2025-04-18 18:48:28,148 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 18:48:28,155 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 18:49:57,533 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 18:49:59,025 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S1R4_rank_genes_clusters_leiden_res0.8.png
2025-04-18 18:49:59,032 [INFO] --- Step 12: Saving Results ---
2025-04-18 18:49:59,045 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 79140, 'n_genes': 2000, 'median_total_counts': 380.0, 'mean_total_counts': 513.9823608398438, 'median_n_genes_by_counts': 291.0, 'mean_n_genes_by_counts': 339.4798205711397, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:49:59,052 [INFO] Saving provenance information to: processed_xenium_CRC_BJM1_S1R4_provenance.json
2025-04-18 18:49:59,064 [INFO] Provenance data saved successfully.
2025-04-18 18:49:59,071 [INFO] Attempting to save final AnnData object to: processed_xenium_CRC_BJM1_S1R4_processed.h5ad
2025-04-18 18:50:14,849 [INFO] Successfully saved processed AnnData object to: processed_xenium_CRC_BJM1_S1R4_processed.h5ad
2025-04-18 18:50:14,856 [INFO] Preprocessing pipeline finished.
2025-04-18 18:50:14,873 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 18:50:14,880 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S1R5
2025-04-18 18:50:14,887 [INFO] Sample ID set to: CRC_BJM1_S1R5
2025-04-18 18:50:14,894 [INFO] --- Step 1: Loading Data ---
2025-04-18 18:50:14,901 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_5__20250205__113422/cell_feature_matrix.h5
2025-04-18 18:50:16,276 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_5__20250205__113422/cells.parquet
2025-04-18 18:50:16,398 [INFO] Initial AnnData object shape: (68010, 5001)
2025-04-18 18:50:16,406 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 18:50:16,413 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 18:50:16,421 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 18:50:16,429 [INFO] Joining metadata from cells parquet file.
2025-04-18 18:50:16,504 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 18:50:16,513 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 18:50:16,529 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide1(0050568)_Region5
2025-04-18 18:50:16,540 [INFO] Found 10 potential core info files.
2025-04-18 18:50:16,610 [INFO] Found 8585 overlapping cells for Core 47 in 47_cells_stats.csv.
2025-04-18 18:50:16,747 [INFO] Found 4735 overlapping cells for Core 48 in 48_cells_stats.csv.
2025-04-18 18:50:16,842 [INFO] Found 9559 overlapping cells for Core 60 in 60_cells_stats.csv.
2025-04-18 18:50:16,942 [INFO] Found 3549 overlapping cells for Core 11 in 11_cells_stats.csv.
2025-04-18 18:50:17,014 [INFO] Found 5705 overlapping cells for Core 12 in 12_cells_stats.csv.
2025-04-18 18:50:17,097 [INFO] Found 7417 overlapping cells for Core 23 in 23_cells_stats.csv.
2025-04-18 18:50:17,187 [INFO] Found 7109 overlapping cells for Core 24 in 24_cells_stats.csv.
2025-04-18 18:50:17,271 [INFO] Found 4433 overlapping cells for Core 35 in 35_cells_stats.csv.
2025-04-18 18:50:17,370 [INFO] Found 5303 overlapping cells for Core 36 in 36_cells_stats.csv.
2025-04-18 18:50:17,854 [INFO] Found 10425 overlapping cells for Core 59 in 59_cells_stats.csv.
2025-04-18 18:50:17,956 [INFO] Assigned Core IDs to 66820/68010 cells.
2025-04-18 18:50:17,967 [INFO] Core value counts:
Core
59      10425
60       9559
47       8585
23       7417
24       7109
12       5705
36       5303
48       4735
35       4433
11       3549
<NA>     1190
Name: count, dtype: int64
2025-04-18 18:50:17,975 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-18 18:50:17,983 [INFO] Converting column 'Transcripts_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:50:18,032 [INFO] Successfully converted 'Transcripts_core' to string.
2025-04-18 18:50:18,040 [INFO] Converting column 'Area (µm^2)_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:50:18,107 [INFO] Successfully converted 'Area (µm^2)_core' to string.
2025-04-18 18:50:18,116 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 18:50:18,144 [INFO] Identified 0 mitochondrial genes.
2025-04-18 18:50:18,155 [INFO] Identified 1 ribosomal genes.
2025-04-18 18:50:18,165 [INFO] Identified 4 hemoglobin genes.
2025-04-18 18:50:18,575 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 68010, 'n_genes': 5001, 'median_total_counts': 370.0, 'mean_total_counts': 524.2421875, 'median_n_genes_by_counts': 282.0, 'mean_n_genes_by_counts': 340.43672989266287, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:50:20,038 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S1R5_qc_violin_before_filter.png
2025-04-18 18:50:20,046 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 18:50:20,053 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 18:50:20,692 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 18:50:20,840 [INFO] Cells to remove based on min_genes (3): 233
2025-04-18 18:50:20,862 [INFO] Cells to remove based on min_counts (10): 902
2025-04-18 18:50:20,872 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 18:50:21,178 [INFO] Filtered cells: 902 cells removed based on combined criteria.
2025-04-18 18:50:21,186 [INFO] AnnData shape after QC filtering: (67108, 5000)
2025-04-18 18:50:22,468 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S1R5_qc_violin_after_filter.png
2025-04-18 18:50:22,475 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 18:50:22,731 [INFO] Saved log-normalized data to adata.raw
2025-04-18 18:50:22,738 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 18:50:22,745 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 18:50:22,916 [INFO] Applying log1p transformation.
2025-04-18 18:50:23,026 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 18:50:23,499 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 18:50:23,514 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 18:50:23,521 [INFO] --- Step 6: Scaling Data ---
2025-04-18 18:50:23,528 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 18:50:26,473 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 18:50:26,481 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 18:50:26,488 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 18:50:32,417 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 18:50:32,440 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 18:50:32,446 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 18:50:32,453 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 18:50:39,759 [INFO] --- Step 9: Clustering ---
2025-04-18 18:50:39,767 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 18:51:45,081 [INFO] Found 16 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 18:51:45,089 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 18:51:45,097 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 18:52:21,991 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S1R5_umap_clusters_leiden_res0.8.png
2025-04-18 18:52:27,012 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S1R5_spatial_clusters_leiden_res0.8.png
2025-04-18 18:52:27,019 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 18:52:27,026 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 18:53:42,531 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 18:53:45,218 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S1R5_rank_genes_clusters_leiden_res0.8.png
2025-04-18 18:53:45,226 [INFO] --- Step 12: Saving Results ---
2025-04-18 18:53:45,240 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 67108, 'n_genes': 2000, 'median_total_counts': 378.0, 'mean_total_counts': 531.2237548828125, 'median_n_genes_by_counts': 287.0, 'mean_n_genes_by_counts': 344.9496483280682, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:53:45,247 [INFO] Saving provenance information to: processed_xenium_CRC_BJM1_S1R5_provenance.json
2025-04-18 18:53:45,258 [INFO] Provenance data saved successfully.
2025-04-18 18:53:45,265 [INFO] Attempting to save final AnnData object to: processed_xenium_CRC_BJM1_S1R5_processed.h5ad
2025-04-18 18:53:58,939 [INFO] Successfully saved processed AnnData object to: processed_xenium_CRC_BJM1_S1R5_processed.h5ad
2025-04-18 18:53:58,949 [INFO] Preprocessing pipeline finished.
2025-04-18 18:53:58,965 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 18:53:58,971 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S1R6
2025-04-18 18:53:58,978 [INFO] Sample ID set to: CRC_BJM1_S1R6
2025-04-18 18:53:58,986 [INFO] --- Step 1: Loading Data ---
2025-04-18 18:53:58,993 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_6__20250205__113422/cell_feature_matrix.h5
2025-04-18 18:54:00,082 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_6__20250205__113422/cells.parquet
2025-04-18 18:54:00,188 [INFO] Initial AnnData object shape: (59106, 5001)
2025-04-18 18:54:00,196 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 18:54:00,203 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 18:54:00,211 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 18:54:00,219 [INFO] Joining metadata from cells parquet file.
2025-04-18 18:54:00,289 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 18:54:00,299 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 18:54:00,312 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide1(0050568)_Region6
2025-04-18 18:54:00,330 [INFO] Found 10 potential core info files.
2025-04-18 18:54:00,411 [INFO] Found 6704 overlapping cells for Core 107 in 107_cells_stats.csv.
2025-04-18 18:54:00,559 [INFO] Found 8103 overlapping cells for Core 108 in 108_cells_stats.csv.
2025-04-18 18:54:00,668 [INFO] Found 4239 overlapping cells for Core 110 in 110_cells_stats.csv.
2025-04-18 18:54:00,754 [INFO] Found 3954 overlapping cells for Core 119 in 119_cells_stats.csv.
2025-04-18 18:54:00,831 [INFO] Found 9345 overlapping cells for Core 71 in 71_cells_stats.csv.
2025-04-18 18:54:00,953 [INFO] Found 8211 overlapping cells for Core 72 in 72_cells_stats.csv.
2025-04-18 18:54:01,047 [INFO] Found 5711 overlapping cells for Core 84 in 84_cells_stats.csv.
2025-04-18 18:54:01,133 [INFO] Found 6454 overlapping cells for Core 95 in 95_cells_stats.csv.
2025-04-18 18:54:01,218 [INFO] Found 5991 overlapping cells for Core 96 in 96_cells_stats.csv.
2025-04-18 18:54:01,310 [INFO] Found 4239 overlapping cells for Core 120 in 120_cells_stats.csv.
2025-04-18 18:54:01,324 [WARNING] 4239 cells in Core 120 file (120_cells_stats.csv) were already assigned to a different Core: ['agiahfdn-1', 'agibccda-1', 'agibjnfm-1', 'agiciheg-1', 'agicpoge-1']...
2025-04-18 18:54:01,440 [WARNING] Value conflict for column 'Transcripts_core' in 4237 cells from 120_cells_stats.csv. See conflict report.
2025-04-18 18:54:01,463 [INFO] Assigned Core IDs to 58712/59106 cells.
2025-04-18 18:54:01,472 [INFO] Core value counts:
Core
71      9345
72      8211
108     8103
107     6704
95      6454
96      5991
84      5711
110     4239
119     3954
<NA>     394
Name: count, dtype: int64
2025-04-18 18:54:01,510 [WARNING] Metadata conflicts detected. Report saved to: processed_xenium_CRC_BJM1_S1R6_core_metadata_conflicts.csv
2025-04-18 18:54:01,517 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-18 18:54:01,525 [INFO] Converting column 'Transcripts_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:54:01,562 [INFO] Successfully converted 'Transcripts_core' to string.
2025-04-18 18:54:01,570 [INFO] Converting column 'Area (µm^2)_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:54:01,624 [INFO] Successfully converted 'Area (µm^2)_core' to string.
2025-04-18 18:54:01,633 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 18:54:01,656 [INFO] Identified 0 mitochondrial genes.
2025-04-18 18:54:01,665 [INFO] Identified 1 ribosomal genes.
2025-04-18 18:54:01,672 [INFO] Identified 4 hemoglobin genes.
2025-04-18 18:54:02,022 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 59106, 'n_genes': 5001, 'median_total_counts': 366.0, 'mean_total_counts': 501.5998229980469, 'median_n_genes_by_counts': 279.0, 'mean_n_genes_by_counts': 327.0680979934355, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:54:03,430 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S1R6_qc_violin_before_filter.png
2025-04-18 18:54:03,438 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 18:54:03,445 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 18:54:03,979 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 18:54:04,106 [INFO] Cells to remove based on min_genes (3): 182
2025-04-18 18:54:04,126 [INFO] Cells to remove based on min_counts (10): 827
2025-04-18 18:54:04,136 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 18:54:04,395 [INFO] Filtered cells: 827 cells removed based on combined criteria.
2025-04-18 18:54:04,403 [INFO] AnnData shape after QC filtering: (58279, 5000)
2025-04-18 18:54:05,640 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S1R6_qc_violin_after_filter.png
2025-04-18 18:54:05,648 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 18:54:05,863 [INFO] Saved log-normalized data to adata.raw
2025-04-18 18:54:05,870 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 18:54:05,877 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 18:54:06,023 [INFO] Applying log1p transformation.
2025-04-18 18:54:06,115 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 18:54:06,507 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 18:54:06,522 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 18:54:06,529 [INFO] --- Step 6: Scaling Data ---
2025-04-18 18:54:06,536 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 18:54:09,038 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 18:54:09,045 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 18:54:09,052 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 18:54:13,998 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 18:54:14,013 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 18:54:14,019 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 18:54:14,025 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 18:54:20,612 [INFO] --- Step 9: Clustering ---
2025-04-18 18:54:20,619 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 18:54:58,987 [INFO] Found 17 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 18:54:58,995 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 18:54:59,002 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 18:55:30,782 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S1R6_umap_clusters_leiden_res0.8.png
2025-04-18 18:55:35,457 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S1R6_spatial_clusters_leiden_res0.8.png
2025-04-18 18:55:35,466 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 18:55:35,473 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 18:56:40,107 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 18:56:41,669 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S1R6_rank_genes_clusters_leiden_res0.8.png
2025-04-18 18:56:41,677 [INFO] --- Step 12: Saving Results ---
2025-04-18 18:56:41,690 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 58279, 'n_genes': 2000, 'median_total_counts': 375.0, 'mean_total_counts': 508.6427001953125, 'median_n_genes_by_counts': 285.0, 'mean_n_genes_by_counts': 331.636661576211, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:56:41,699 [INFO] Saving provenance information to: processed_xenium_CRC_BJM1_S1R6_provenance.json
2025-04-18 18:56:41,709 [INFO] Provenance data saved successfully.
2025-04-18 18:56:41,719 [INFO] Attempting to save final AnnData object to: processed_xenium_CRC_BJM1_S1R6_processed.h5ad
2025-04-18 18:56:53,244 [INFO] Successfully saved processed AnnData object to: processed_xenium_CRC_BJM1_S1R6_processed.h5ad
2025-04-18 18:56:53,252 [INFO] Preprocessing pipeline finished.
2025-04-18 18:56:53,270 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 18:56:53,277 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S1R7
2025-04-18 18:56:53,283 [INFO] Sample ID set to: CRC_BJM1_S1R7
2025-04-18 18:56:53,290 [INFO] --- Step 1: Loading Data ---
2025-04-18 18:56:53,297 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_7__20250205__113422/cell_feature_matrix.h5
2025-04-18 18:56:53,305 [ERROR] File not found: [Errno 2] Unable to synchronously open file (unable to open file: name = '/data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_7__20250205__113422/cell_feature_matrix.h5', errno = 2, error message = 'No such file or directory', flags = 0, o_flags = 0). Aborting.
2025-04-18 18:56:53,323 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 18:56:53,330 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S1R8
2025-04-18 18:56:53,337 [INFO] Sample ID set to: CRC_BJM1_S1R8
2025-04-18 18:56:53,344 [INFO] --- Step 1: Loading Data ---
2025-04-18 18:56:53,350 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_8__20250205__113422/cell_feature_matrix.h5
2025-04-18 18:56:53,362 [ERROR] File not found: [Errno 2] Unable to synchronously open file (unable to open file: name = '/data/ARPAH/250210_CRC_BJM/output-XETG00274__0050586__Region_8__20250205__113422/cell_feature_matrix.h5', errno = 2, error message = 'No such file or directory', flags = 0, o_flags = 0). Aborting.
2025-04-18 18:56:53,401 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 18:56:53,409 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R1
2025-04-18 18:56:53,417 [INFO] Sample ID set to: CRC_BJM1_S2R1
2025-04-18 18:56:53,425 [INFO] --- Step 1: Loading Data ---
2025-04-18 18:56:53,434 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cell_feature_matrix.h5
2025-04-18 18:56:54,861 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_1__20250205__113422/cells.parquet
2025-04-18 18:56:54,923 [INFO] Initial AnnData object shape: (67645, 5001)
2025-04-18 18:56:54,931 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 18:56:54,938 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 18:56:54,945 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 18:56:54,951 [INFO] Joining metadata from cells parquet file.
2025-04-18 18:56:54,991 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 18:56:54,998 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 18:56:55,010 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide2(0050585)_Region1
2025-04-18 18:56:55,020 [INFO] Found 10 potential core info files.
2025-04-18 18:56:55,105 [INFO] Found 8190 overlapping cells for Core 13 in 13_cells_stats.csv.
2025-04-18 18:56:55,265 [INFO] Found 9085 overlapping cells for Core 14 in 14_cells_stats.csv.
2025-04-18 18:56:55,371 [INFO] Found 2638 overlapping cells for Core 1 in 1_cells_stats.csv.
2025-04-18 18:56:55,431 [INFO] Found 7281 overlapping cells for Core 25 in 25_cells_stats.csv.
2025-04-18 18:56:55,521 [INFO] Found 6403 overlapping cells for Core 26 in 26_cells_stats.csv.
2025-04-18 18:56:55,604 [INFO] Found 3737 overlapping cells for Core 2 in 2_cells_stats.csv.
2025-04-18 18:56:55,670 [INFO] Found 6759 overlapping cells for Core 37 in 37_cells_stats.csv.
2025-04-18 18:56:55,775 [INFO] Found 9320 overlapping cells for Core 38 in 38_cells_stats.csv.
2025-04-18 18:56:55,879 [INFO] Found 6934 overlapping cells for Core 49 in 49_cells_stats.csv.
2025-04-18 18:56:55,985 [INFO] Found 7201 overlapping cells for Core 50 in 50_cells_stats.csv.
2025-04-18 18:56:56,053 [INFO] Assigned Core IDs to 67548/67645 cells.
2025-04-18 18:56:56,062 [INFO] Core value counts:
Core
38      9320
14      9085
13      8190
25      7281
50      7201
49      6934
37      6759
26      6403
2       3737
1       2638
<NA>      97
Name: count, dtype: int64
2025-04-18 18:56:56,070 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-18 18:56:56,077 [INFO] Converting column 'Transcripts_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:56:56,120 [INFO] Successfully converted 'Transcripts_core' to string.
2025-04-18 18:56:56,128 [INFO] Converting column 'Area (µm^2)_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 18:56:56,191 [INFO] Successfully converted 'Area (µm^2)_core' to string.
2025-04-18 18:56:56,202 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 18:56:56,228 [INFO] Identified 0 mitochondrial genes.
2025-04-18 18:56:56,238 [INFO] Identified 1 ribosomal genes.
2025-04-18 18:56:56,247 [INFO] Identified 4 hemoglobin genes.
2025-04-18 18:56:56,566 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 67645, 'n_genes': 5001, 'median_total_counts': 246.0, 'mean_total_counts': 329.0464782714844, 'median_n_genes_by_counts': 206.0, 'mean_n_genes_by_counts': 247.12465075024022, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 18:56:58,065 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S2R1_qc_violin_before_filter.png
2025-04-18 18:56:58,072 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 18:56:58,079 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 18:56:58,552 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 18:56:58,663 [INFO] Cells to remove based on min_genes (3): 208
2025-04-18 18:56:58,682 [INFO] Cells to remove based on min_counts (10): 593
2025-04-18 18:56:58,692 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 18:56:58,930 [INFO] Filtered cells: 593 cells removed based on combined criteria.
2025-04-18 18:56:58,937 [INFO] AnnData shape after QC filtering: (67052, 5000)
2025-04-18 18:57:00,256 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S2R1_qc_violin_after_filter.png
2025-04-18 18:57:00,263 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 18:57:00,454 [INFO] Saved log-normalized data to adata.raw
2025-04-18 18:57:00,461 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 18:57:00,468 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 18:57:00,598 [INFO] Applying log1p transformation.
2025-04-18 18:57:00,677 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 18:57:01,026 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 18:57:01,040 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 18:57:01,056 [INFO] --- Step 6: Scaling Data ---
2025-04-18 18:57:01,063 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 18:57:03,616 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 18:57:03,624 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 18:57:03,630 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 18:57:09,947 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 18:57:09,963 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 18:57:09,971 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 18:57:09,978 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 18:57:17,784 [INFO] --- Step 9: Clustering ---
2025-04-18 18:57:17,792 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 18:58:44,931 [INFO] Found 20 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 18:58:44,939 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 18:58:44,946 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 18:59:23,782 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_umap_clusters_leiden_res0.8.png
2025-04-18 18:59:28,997 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R1_spatial_clusters_leiden_res0.8.png
2025-04-18 18:59:29,005 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 18:59:29,011 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 19:00:41,045 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 19:00:42,861 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S2R1_rank_genes_clusters_leiden_res0.8.png
2025-04-18 19:00:42,868 [INFO] --- Step 12: Saving Results ---
2025-04-18 19:00:42,882 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 67052, 'n_genes': 2000, 'median_total_counts': 248.0, 'mean_total_counts': 331.9176330566406, 'median_n_genes_by_counts': 208.0, 'mean_n_genes_by_counts': 249.2720724214043, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 19:00:42,889 [INFO] Saving provenance information to: processed_xenium_CRC_BJM1_S2R1_provenance.json
2025-04-18 19:00:42,900 [INFO] Provenance data saved successfully.
2025-04-18 19:00:42,906 [INFO] Attempting to save final AnnData object to: processed_xenium_CRC_BJM1_S2R1_processed.h5ad
2025-04-18 19:00:55,027 [INFO] Successfully saved processed AnnData object to: processed_xenium_CRC_BJM1_S2R1_processed.h5ad
2025-04-18 19:00:55,037 [INFO] Preprocessing pipeline finished.
2025-04-18 19:00:55,053 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 19:00:55,060 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R2
2025-04-18 19:00:55,067 [INFO] Sample ID set to: CRC_BJM1_S2R2
2025-04-18 19:00:55,074 [INFO] --- Step 1: Loading Data ---
2025-04-18 19:00:55,080 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_2__20250205__113422/cell_feature_matrix.h5
2025-04-18 19:00:55,876 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_2__20250205__113422/cells.parquet
2025-04-18 19:00:55,944 [INFO] Initial AnnData object shape: (43050, 5001)
2025-04-18 19:00:55,951 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 19:00:55,960 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 19:00:55,967 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 19:00:55,974 [INFO] Joining metadata from cells parquet file.
2025-04-18 19:00:56,021 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 19:00:56,029 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 19:00:56,043 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide2(0050585)_Region2
2025-04-18 19:00:56,063 [INFO] Found 10 potential core info files.
2025-04-18 19:00:56,129 [INFO] Found 4052 overlapping cells for Core 109 in 109_cells_stats.csv.
2025-04-18 19:00:56,240 [INFO] Found 422 overlapping cells for Core 110 in 110_cells_stats.csv.
2025-04-18 19:00:56,309 [INFO] Found 5544 overlapping cells for Core 61 in 61_cells_stats.csv.
2025-04-18 19:00:56,385 [INFO] Found 2171 overlapping cells for Core 62 in 62_cells_stats.csv.
2025-04-18 19:00:56,453 [INFO] Found 7062 overlapping cells for Core 73 in 73_cells_stats.csv.
2025-04-18 19:00:56,543 [INFO] Found 6771 overlapping cells for Core 74 in 74_cells_stats.csv.
2025-04-18 19:00:56,642 [INFO] Found 4960 overlapping cells for Core 85 in 85_cells_stats.csv.
2025-04-18 19:00:56,739 [INFO] Found 6831 overlapping cells for Core 86 in 86_cells_stats.csv.
2025-04-18 19:00:56,822 [INFO] Found 4097 overlapping cells for Core 97 in 97_cells_stats.csv.
2025-04-18 19:00:56,888 [INFO] Found 858 overlapping cells for Core 98 in 98_cells_stats.csv.
2025-04-18 19:00:56,915 [INFO] Assigned Core IDs to 42768/43050 cells.
2025-04-18 19:00:56,925 [INFO] Core value counts:
Core
73      7062
86      6831
74      6771
61      5544
85      4960
97      4097
109     4052
62      2171
98       858
110      422
<NA>     282
Name: count, dtype: int64
2025-04-18 19:00:56,932 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-18 19:00:56,940 [INFO] Converting column 'Transcripts_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 19:00:56,972 [INFO] Successfully converted 'Transcripts_core' to string.
2025-04-18 19:00:56,981 [INFO] Converting column 'Area (µm^2)_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 19:00:57,028 [INFO] Successfully converted 'Area (µm^2)_core' to string.
2025-04-18 19:00:57,037 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 19:00:57,062 [INFO] Identified 0 mitochondrial genes.
2025-04-18 19:00:57,074 [INFO] Identified 1 ribosomal genes.
2025-04-18 19:00:57,083 [INFO] Identified 4 hemoglobin genes.
2025-04-18 19:00:57,309 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 43050, 'n_genes': 5001, 'median_total_counts': 244.0, 'mean_total_counts': 320.5161437988281, 'median_n_genes_by_counts': 203.0, 'mean_n_genes_by_counts': 237.93626016260163, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 19:00:58,500 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S2R2_qc_violin_before_filter.png
2025-04-18 19:00:58,509 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 19:00:58,516 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 19:00:58,819 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 19:00:58,877 [INFO] Cells to remove based on min_genes (3): 234
2025-04-18 19:00:58,894 [INFO] Cells to remove based on min_counts (10): 677
2025-04-18 19:00:58,903 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 19:00:59,033 [INFO] Filtered cells: 677 cells removed based on combined criteria.
2025-04-18 19:00:59,041 [INFO] AnnData shape after QC filtering: (42373, 5000)
2025-04-18 19:01:00,056 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S2R2_qc_violin_after_filter.png
2025-04-18 19:01:00,065 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 19:01:00,180 [INFO] Saved log-normalized data to adata.raw
2025-04-18 19:01:00,188 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 19:01:00,195 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 19:01:00,271 [INFO] Applying log1p transformation.
2025-04-18 19:01:00,325 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 19:01:00,548 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 19:01:00,565 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 19:01:00,573 [INFO] --- Step 6: Scaling Data ---
2025-04-18 19:01:00,580 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 19:01:02,159 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 19:01:02,167 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 19:01:02,174 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 19:01:06,137 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 19:01:06,157 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 19:01:06,165 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 19:01:06,172 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 19:01:11,792 [INFO] --- Step 9: Clustering ---
2025-04-18 19:01:11,801 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 19:01:49,945 [INFO] Found 21 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 19:01:49,953 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 19:01:49,960 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 19:02:12,706 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R2_umap_clusters_leiden_res0.8.png
2025-04-18 19:02:16,683 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R2_spatial_clusters_leiden_res0.8.png
2025-04-18 19:02:16,692 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 19:02:16,699 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 19:03:03,276 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 19:03:05,197 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S2R2_rank_genes_clusters_leiden_res0.8.png
2025-04-18 19:03:05,205 [INFO] --- Step 12: Saving Results ---
2025-04-18 19:03:05,217 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 42373, 'n_genes': 2000, 'median_total_counts': 249.0, 'mean_total_counts': 325.5673522949219, 'median_n_genes_by_counts': 206.0, 'mean_n_genes_by_counts': 241.67014372359756, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 19:03:05,224 [INFO] Saving provenance information to: processed_xenium_CRC_BJM1_S2R2_provenance.json
2025-04-18 19:03:05,235 [INFO] Provenance data saved successfully.
2025-04-18 19:03:05,242 [INFO] Attempting to save final AnnData object to: processed_xenium_CRC_BJM1_S2R2_processed.h5ad
2025-04-18 19:03:12,493 [INFO] Successfully saved processed AnnData object to: processed_xenium_CRC_BJM1_S2R2_processed.h5ad
2025-04-18 19:03:12,500 [INFO] Preprocessing pipeline finished.
2025-04-18 19:03:12,511 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 19:03:12,518 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R3
2025-04-18 19:03:12,525 [INFO] Sample ID set to: CRC_BJM1_S2R3
2025-04-18 19:03:12,531 [INFO] --- Step 1: Loading Data ---
2025-04-18 19:03:12,538 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_3__20250205__113422/cell_feature_matrix.h5
2025-04-18 19:03:14,270 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_3__20250205__113422/cells.parquet
2025-04-18 19:03:14,380 [INFO] Initial AnnData object shape: (87756, 5001)
2025-04-18 19:03:14,388 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 19:03:14,395 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 19:03:14,402 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 19:03:14,410 [INFO] Joining metadata from cells parquet file.
2025-04-18 19:03:14,494 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 19:03:14,503 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 19:03:14,516 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide2(0050585)_Region3
2025-04-18 19:03:14,541 [INFO] Found 10 potential core info files.
2025-04-18 19:03:14,635 [INFO] Found 6531 overlapping cells for Core 15 in 15_cells_stats.csv.
2025-04-18 19:03:14,794 [INFO] Found 8806 overlapping cells for Core 16 in 16_cells_stats.csv.
2025-04-18 19:03:14,922 [INFO] Found 8388 overlapping cells for Core 27 in 27_cells_stats.csv.
2025-04-18 19:03:15,028 [INFO] Found 7403 overlapping cells for Core 28 in 28_cells_stats.csv.
2025-04-18 19:03:15,133 [INFO] Found 7682 overlapping cells for Core 39 in 39_cells_stats.csv.
2025-04-18 19:03:15,248 [INFO] Found 15505 overlapping cells for Core 3 in 3_cells_stats.csv.
2025-04-18 19:03:15,400 [INFO] Found 7626 overlapping cells for Core 40 in 40_cells_stats.csv.
2025-04-18 19:03:15,508 [INFO] Found 9925 overlapping cells for Core 4 in 4_cells_stats.csv.
2025-04-18 19:03:15,622 [INFO] Found 7246 overlapping cells for Core 51 in 51_cells_stats.csv.
2025-04-18 19:03:15,695 [INFO] Found 8287 overlapping cells for Core 52 in 52_cells_stats.csv.
2025-04-18 19:03:15,758 [INFO] Assigned Core IDs to 87399/87756 cells.
2025-04-18 19:03:15,767 [INFO] Core value counts:
Core
3       15505
4        9925
16       8806
27       8388
52       8287
39       7682
40       7626
28       7403
51       7246
15       6531
<NA>      357
Name: count, dtype: int64
2025-04-18 19:03:15,774 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-18 19:03:15,781 [INFO] Converting column 'Transcripts_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 19:03:15,818 [INFO] Successfully converted 'Transcripts_core' to string.
2025-04-18 19:03:15,826 [INFO] Converting column 'Area (µm^2)_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 19:03:15,881 [INFO] Successfully converted 'Area (µm^2)_core' to string.
2025-04-18 19:03:15,889 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 19:03:15,910 [INFO] Identified 0 mitochondrial genes.
2025-04-18 19:03:15,917 [INFO] Identified 1 ribosomal genes.
2025-04-18 19:03:15,924 [INFO] Identified 4 hemoglobin genes.
2025-04-18 19:03:16,340 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 87756, 'n_genes': 5001, 'median_total_counts': 389.0, 'mean_total_counts': 544.1489868164062, 'median_n_genes_by_counts': 305.0, 'mean_n_genes_by_counts': 360.8014950544692, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 19:03:18,030 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S2R3_qc_violin_before_filter.png
2025-04-18 19:03:18,039 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 19:03:18,046 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 19:03:18,992 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 19:03:19,220 [INFO] Cells to remove based on min_genes (3): 409
2025-04-18 19:03:19,246 [INFO] Cells to remove based on min_counts (10): 1402
2025-04-18 19:03:19,257 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 19:03:19,702 [INFO] Filtered cells: 1402 cells removed based on combined criteria.
2025-04-18 19:03:19,709 [INFO] AnnData shape after QC filtering: (86354, 5000)
2025-04-18 19:03:21,217 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S2R3_qc_violin_after_filter.png
2025-04-18 19:03:21,224 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 19:03:21,597 [INFO] Saved log-normalized data to adata.raw
2025-04-18 19:03:21,604 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 19:03:21,610 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 19:03:21,838 [INFO] Applying log1p transformation.
2025-04-18 19:03:21,983 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 19:03:22,611 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 19:03:22,625 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 19:03:22,632 [INFO] --- Step 6: Scaling Data ---
2025-04-18 19:03:22,639 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 19:03:26,625 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 19:03:26,633 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 19:03:26,640 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 19:03:32,984 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 19:03:33,006 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 19:03:33,009 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 19:03:33,012 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 19:03:42,625 [INFO] --- Step 9: Clustering ---
2025-04-18 19:03:42,633 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 19:05:03,504 [INFO] Found 17 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 19:05:03,512 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 19:05:03,519 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 19:05:56,148 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R3_umap_clusters_leiden_res0.8.png
2025-04-18 19:06:02,584 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R3_spatial_clusters_leiden_res0.8.png
2025-04-18 19:06:02,592 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 19:06:02,599 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 19:07:40,119 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 19:07:43,266 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S2R3_rank_genes_clusters_leiden_res0.8.png
2025-04-18 19:07:43,274 [INFO] --- Step 12: Saving Results ---
2025-04-18 19:07:43,287 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 86354, 'n_genes': 2000, 'median_total_counts': 398.0, 'mean_total_counts': 552.9097290039062, 'median_n_genes_by_counts': 310.0, 'mean_n_genes_by_counts': 366.58796349908516, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 19:07:43,294 [INFO] Saving provenance information to: processed_xenium_CRC_BJM1_S2R3_provenance.json
2025-04-18 19:07:43,324 [INFO] Provenance data saved successfully.
2025-04-18 19:07:43,332 [INFO] Attempting to save final AnnData object to: processed_xenium_CRC_BJM1_S2R3_processed.h5ad
2025-04-18 19:08:01,834 [INFO] Successfully saved processed AnnData object to: processed_xenium_CRC_BJM1_S2R3_processed.h5ad
2025-04-18 19:08:01,843 [INFO] Preprocessing pipeline finished.
2025-04-18 19:08:01,861 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 19:08:01,868 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R4
2025-04-18 19:08:01,875 [INFO] Sample ID set to: CRC_BJM1_S2R4
2025-04-18 19:08:01,883 [INFO] --- Step 1: Loading Data ---
2025-04-18 19:08:01,890 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_4__20250205__113422/cell_feature_matrix.h5
2025-04-18 19:08:03,270 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_4__20250205__113422/cells.parquet
2025-04-18 19:08:03,385 [INFO] Initial AnnData object shape: (74609, 5001)
2025-04-18 19:08:03,392 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 19:08:03,399 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 19:08:03,406 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 19:08:03,414 [INFO] Joining metadata from cells parquet file.
2025-04-18 19:08:03,490 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 19:08:03,499 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 19:08:03,512 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide2(0050585)_Region4
2025-04-18 19:08:03,528 [INFO] Found 10 potential core info files.
2025-04-18 19:08:03,611 [INFO] Found 7519 overlapping cells for Core 100 in 100_cells_stats.csv.
2025-04-18 19:08:03,764 [INFO] Found 8330 overlapping cells for Core 111 in 111_cells_stats.csv.
2025-04-18 19:08:03,878 [INFO] Found 6530 overlapping cells for Core 112 in 112_cells_stats.csv.
2025-04-18 19:08:03,970 [INFO] Found 5913 overlapping cells for Core 63 in 63_cells_stats.csv.
2025-04-18 19:08:04,056 [INFO] Found 8144 overlapping cells for Core 64 in 64_cells_stats.csv.
2025-04-18 19:08:04,159 [INFO] Found 9393 overlapping cells for Core 75 in 75_cells_stats.csv.
2025-04-18 19:08:04,286 [INFO] Found 4481 overlapping cells for Core 76 in 76_cells_stats.csv.
2025-04-18 19:08:04,367 [INFO] Found 6832 overlapping cells for Core 87 in 87_cells_stats.csv.
2025-04-18 19:08:04,461 [INFO] Found 6035 overlapping cells for Core 88 in 88_cells_stats.csv.
2025-04-18 19:08:04,555 [INFO] Found 11086 overlapping cells for Core 99 in 99_cells_stats.csv.
2025-04-18 19:08:04,630 [INFO] Assigned Core IDs to 74263/74609 cells.
2025-04-18 19:08:04,639 [INFO] Core value counts:
Core
99      11086
75       9393
111      8330
64       8144
100      7519
87       6832
112      6530
88       6035
63       5913
76       4481
<NA>      346
Name: count, dtype: int64
2025-04-18 19:08:04,646 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-18 19:08:04,653 [INFO] Converting column 'Transcripts_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 19:08:04,689 [INFO] Successfully converted 'Transcripts_core' to string.
2025-04-18 19:08:04,696 [INFO] Converting column 'Area (µm^2)_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 19:08:04,744 [INFO] Successfully converted 'Area (µm^2)_core' to string.
2025-04-18 19:08:04,752 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 19:08:04,766 [INFO] Identified 0 mitochondrial genes.
2025-04-18 19:08:04,774 [INFO] Identified 1 ribosomal genes.
2025-04-18 19:08:04,781 [INFO] Identified 4 hemoglobin genes.
2025-04-18 19:08:05,117 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 74609, 'n_genes': 5001, 'median_total_counts': 373.0, 'mean_total_counts': 531.5138549804688, 'median_n_genes_by_counts': 285.0, 'mean_n_genes_by_counts': 339.31224115053146, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 19:08:06,690 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S2R4_qc_violin_before_filter.png
2025-04-18 19:08:06,697 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 19:08:06,704 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 19:08:07,484 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 19:08:07,677 [INFO] Cells to remove based on min_genes (3): 186
2025-04-18 19:08:07,701 [INFO] Cells to remove based on min_counts (10): 894
2025-04-18 19:08:07,711 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 19:08:08,087 [INFO] Filtered cells: 894 cells removed based on combined criteria.
2025-04-18 19:08:08,095 [INFO] AnnData shape after QC filtering: (73715, 5000)
2025-04-18 19:08:09,503 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S2R4_qc_violin_after_filter.png
2025-04-18 19:08:09,511 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 19:08:09,820 [INFO] Saved log-normalized data to adata.raw
2025-04-18 19:08:09,828 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 19:08:09,834 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 19:08:10,028 [INFO] Applying log1p transformation.
2025-04-18 19:08:10,149 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 19:08:10,696 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 19:08:10,710 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 19:08:10,717 [INFO] --- Step 6: Scaling Data ---
2025-04-18 19:08:10,724 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 19:08:13,894 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 19:08:13,902 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 19:08:13,911 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 19:08:19,437 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 19:08:19,458 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 19:08:19,467 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 19:08:19,474 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 19:08:28,045 [INFO] --- Step 9: Clustering ---
2025-04-18 19:08:28,053 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 19:09:23,893 [INFO] Found 19 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 19:09:23,901 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 19:09:23,908 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 19:10:08,952 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R4_umap_clusters_leiden_res0.8.png
2025-04-18 19:10:14,790 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R4_spatial_clusters_leiden_res0.8.png
2025-04-18 19:10:14,798 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 19:10:14,804 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 19:11:37,583 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 19:11:39,516 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S2R4_rank_genes_clusters_leiden_res0.8.png
2025-04-18 19:11:39,525 [INFO] --- Step 12: Saving Results ---
2025-04-18 19:11:39,538 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 73715, 'n_genes': 2000, 'median_total_counts': 380.0, 'mean_total_counts': 537.89599609375, 'median_n_genes_by_counts': 289.0, 'mean_n_genes_by_counts': 343.3652580885844, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 19:11:39,545 [INFO] Saving provenance information to: processed_xenium_CRC_BJM1_S2R4_provenance.json
2025-04-18 19:11:39,554 [INFO] Provenance data saved successfully.
2025-04-18 19:11:39,561 [INFO] Attempting to save final AnnData object to: processed_xenium_CRC_BJM1_S2R4_processed.h5ad
2025-04-18 19:11:54,906 [INFO] Successfully saved processed AnnData object to: processed_xenium_CRC_BJM1_S2R4_processed.h5ad
2025-04-18 19:11:54,914 [INFO] Preprocessing pipeline finished.
2025-04-18 19:11:54,930 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 19:11:54,942 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R5
2025-04-18 19:11:54,949 [INFO] Sample ID set to: CRC_BJM1_S2R5
2025-04-18 19:11:54,956 [INFO] --- Step 1: Loading Data ---
2025-04-18 19:11:54,963 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_5__20250205__113422/cell_feature_matrix.h5
2025-04-18 19:11:56,014 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_5__20250205__113422/cells.parquet
2025-04-18 19:11:56,127 [INFO] Initial AnnData object shape: (57389, 5001)
2025-04-18 19:11:56,135 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 19:11:56,142 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 19:11:56,149 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 19:11:56,156 [INFO] Joining metadata from cells parquet file.
2025-04-18 19:11:56,233 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 19:11:56,242 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 19:11:56,255 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide2(0050585)_Region5
2025-04-18 19:11:56,274 [INFO] Found 10 potential core info files.
2025-04-18 19:11:56,349 [INFO] Found 3600 overlapping cells for Core 17 in 17_cells_stats.csv.
2025-04-18 19:11:56,471 [INFO] Found 7053 overlapping cells for Core 18 in 18_cells_stats.csv.
2025-04-18 19:11:56,576 [INFO] Found 6143 overlapping cells for Core 29 in 29_cells_stats.csv.
2025-04-18 19:11:56,669 [INFO] Found 6459 overlapping cells for Core 30 in 30_cells_stats.csv.
2025-04-18 19:11:56,751 [INFO] Found 4318 overlapping cells for Core 41 in 41_cells_stats.csv.
2025-04-18 19:11:56,823 [INFO] Found 7432 overlapping cells for Core 42 in 42_cells_stats.csv.
2025-04-18 19:11:56,918 [INFO] Found 6122 overlapping cells for Core 53 in 53_cells_stats.csv.
2025-04-18 19:11:56,999 [INFO] Found 5641 overlapping cells for Core 54 in 54_cells_stats.csv.
2025-04-18 19:11:57,075 [INFO] Found 4752 overlapping cells for Core 5 in 5_cells_stats.csv.
2025-04-18 19:11:57,148 [INFO] Found 5748 overlapping cells for Core 6 in 6_cells_stats.csv.
2025-04-18 19:11:57,203 [INFO] Assigned Core IDs to 57268/57389 cells.
2025-04-18 19:11:57,212 [INFO] Core value counts:
Core
42      7432
18      7053
30      6459
29      6143
53      6122
6       5748
54      5641
5       4752
41      4318
17      3600
<NA>     121
Name: count, dtype: int64
2025-04-18 19:11:57,220 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-18 19:11:57,228 [INFO] Converting column 'Transcripts_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 19:11:57,266 [INFO] Successfully converted 'Transcripts_core' to string.
2025-04-18 19:11:57,274 [INFO] Converting column 'Area (µm^2)_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 19:11:57,327 [INFO] Successfully converted 'Area (µm^2)_core' to string.
2025-04-18 19:11:57,335 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 19:11:57,361 [INFO] Identified 0 mitochondrial genes.
2025-04-18 19:11:57,371 [INFO] Identified 1 ribosomal genes.
2025-04-18 19:11:57,382 [INFO] Identified 4 hemoglobin genes.
2025-04-18 19:11:57,670 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 57389, 'n_genes': 5001, 'median_total_counts': 227.0, 'mean_total_counts': 398.32574462890625, 'median_n_genes_by_counts': 187.0, 'mean_n_genes_by_counts': 268.02258272491247, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 19:11:59,047 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S2R5_qc_violin_before_filter.png
2025-04-18 19:11:59,055 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 19:11:59,061 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 19:11:59,522 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 19:11:59,631 [INFO] Cells to remove based on min_genes (3): 315
2025-04-18 19:11:59,654 [INFO] Cells to remove based on min_counts (10): 1225
2025-04-18 19:11:59,665 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 19:11:59,893 [INFO] Filtered cells: 1225 cells removed based on combined criteria.
2025-04-18 19:11:59,903 [INFO] AnnData shape after QC filtering: (56164, 5000)
2025-04-18 19:12:01,099 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S2R5_qc_violin_after_filter.png
2025-04-18 19:12:01,109 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 19:12:01,281 [INFO] Saved log-normalized data to adata.raw
2025-04-18 19:12:01,289 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 19:12:01,301 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 19:12:01,416 [INFO] Applying log1p transformation.
2025-04-18 19:12:01,492 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 19:12:01,880 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 19:12:01,898 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 19:12:01,906 [INFO] --- Step 6: Scaling Data ---
2025-04-18 19:12:01,918 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 19:12:03,983 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 19:12:03,993 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 19:12:04,000 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 19:12:08,917 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 19:12:08,936 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 19:12:08,944 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 19:12:08,951 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 19:12:16,527 [INFO] --- Step 9: Clustering ---
2025-04-18 19:12:16,536 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 19:12:42,830 [INFO] Found 18 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 19:12:42,837 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 19:12:42,844 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 19:13:21,574 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R5_umap_clusters_leiden_res0.8.png
2025-04-18 19:13:26,868 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R5_spatial_clusters_leiden_res0.8.png
2025-04-18 19:13:26,875 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 19:13:26,884 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 19:14:30,296 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 19:14:32,066 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S2R5_rank_genes_clusters_leiden_res0.8.png
2025-04-18 19:14:32,074 [INFO] --- Step 12: Saving Results ---
2025-04-18 19:14:32,087 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 56164, 'n_genes': 2000, 'median_total_counts': 236.0, 'mean_total_counts': 406.9059753417969, 'median_n_genes_by_counts': 192.0, 'mean_n_genes_by_counts': 273.76397692472045, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 19:14:32,094 [INFO] Saving provenance information to: processed_xenium_CRC_BJM1_S2R5_provenance.json
2025-04-18 19:14:32,105 [INFO] Provenance data saved successfully.
2025-04-18 19:14:32,112 [INFO] Attempting to save final AnnData object to: processed_xenium_CRC_BJM1_S2R5_processed.h5ad
2025-04-18 19:14:42,602 [INFO] Successfully saved processed AnnData object to: processed_xenium_CRC_BJM1_S2R5_processed.h5ad
2025-04-18 19:14:42,610 [INFO] Preprocessing pipeline finished.
2025-04-18 19:14:42,626 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 19:14:42,633 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R6
2025-04-18 19:14:42,640 [INFO] Sample ID set to: CRC_BJM1_S2R6
2025-04-18 19:14:42,647 [INFO] --- Step 1: Loading Data ---
2025-04-18 19:14:42,654 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_6__20250205__113422/cell_feature_matrix.h5
2025-04-18 19:14:44,031 [INFO] Reading cells parquet file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_6__20250205__113422/cells.parquet
2025-04-18 19:14:44,131 [INFO] Initial AnnData object shape: (58216, 5001)
2025-04-18 19:14:44,139 [INFO] Available obs columns from H5: ['sample_id']
2025-04-18 19:14:44,146 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-18 19:14:44,154 [INFO] --- Step 2: Integrating Metadata ---
2025-04-18 19:14:44,162 [INFO] Joining metadata from cells parquet file.
2025-04-18 19:14:44,229 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-18 19:14:44,237 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-18 19:14:44,251 [INFO] Integrating core information from directory: /data/ARPAH/250210_CRC_BJM/cell_ID/slide2(0050585)_Region6
2025-04-18 19:14:44,275 [INFO] Found 10 potential core info files.
2025-04-18 19:14:44,380 [INFO] Found 6294 overlapping cells for Core 101 in 101_cells_stats.csv.
2025-04-18 19:14:44,536 [INFO] Found 5818 overlapping cells for Core 102 in 102_cells_stats.csv.
2025-04-18 19:14:44,619 [INFO] Found 3213 overlapping cells for Core 113 in 113_cells_stats.csv.
2025-04-18 19:14:44,694 [INFO] Found 4747 overlapping cells for Core 114 in 114_cells_stats.csv.
2025-04-18 19:14:44,773 [INFO] Found 6720 overlapping cells for Core 65 in 65_cells_stats.csv.
2025-04-18 19:14:44,876 [INFO] Found 6893 overlapping cells for Core 66 in 66_cells_stats.csv.
2025-04-18 19:14:45,021 [INFO] Found 6293 overlapping cells for Core 77 in 77_cells_stats.csv.
2025-04-18 19:14:45,105 [INFO] Found 4939 overlapping cells for Core 78 in 78_cells_stats.csv.
2025-04-18 19:14:45,201 [INFO] Found 6027 overlapping cells for Core 89 in 89_cells_stats.csv.
2025-04-18 19:14:45,284 [INFO] Found 6979 overlapping cells for Core 90 in 90_cells_stats.csv.
2025-04-18 19:14:45,351 [INFO] Assigned Core IDs to 57923/58216 cells.
2025-04-18 19:14:45,361 [INFO] Core value counts:
Core
90      6979
66      6893
65      6720
101     6294
77      6293
89      6027
102     5818
78      4939
114     4747
113     3213
<NA>     293
Name: count, dtype: int64
2025-04-18 19:14:45,368 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-18 19:14:45,376 [INFO] Converting column 'Transcripts_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 19:14:45,415 [INFO] Successfully converted 'Transcripts_core' to string.
2025-04-18 19:14:45,423 [INFO] Converting column 'Area (µm^2)_core' (dtype: object) to string type (NA -> 'NA_placeholder')...
2025-04-18 19:14:45,475 [INFO] Successfully converted 'Area (µm^2)_core' to string.
2025-04-18 19:14:45,484 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-18 19:14:45,509 [INFO] Identified 0 mitochondrial genes.
2025-04-18 19:14:45,519 [INFO] Identified 1 ribosomal genes.
2025-04-18 19:14:45,529 [INFO] Identified 4 hemoglobin genes.
2025-04-18 19:14:45,932 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 58216, 'n_genes': 5001, 'median_total_counts': 451.0, 'mean_total_counts': 633.80908203125, 'median_n_genes_by_counts': 331.0, 'mean_n_genes_by_counts': 391.5423938436169, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 19:14:47,356 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_CRC_BJM1_S2R6_qc_violin_before_filter.png
2025-04-18 19:14:47,364 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-18 19:14:47,371 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-18 19:14:48,080 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-18 19:14:48,251 [INFO] Cells to remove based on min_genes (3): 142
2025-04-18 19:14:48,273 [INFO] Cells to remove based on min_counts (10): 458
2025-04-18 19:14:48,284 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-18 19:14:48,615 [INFO] Filtered cells: 458 cells removed based on combined criteria.
2025-04-18 19:14:48,623 [INFO] AnnData shape after QC filtering: (57758, 5000)
2025-04-18 19:14:49,896 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_CRC_BJM1_S2R6_qc_violin_after_filter.png
2025-04-18 19:14:49,903 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-18 19:14:50,177 [INFO] Saved log-normalized data to adata.raw
2025-04-18 19:14:50,185 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-18 19:14:50,192 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-18 19:14:50,362 [INFO] Applying log1p transformation.
2025-04-18 19:14:50,471 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-18 19:14:50,958 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-18 19:14:50,972 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-18 19:14:50,979 [INFO] --- Step 6: Scaling Data ---
2025-04-18 19:14:50,986 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-18 19:14:53,795 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-18 19:14:53,802 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-18 19:14:53,809 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-18 19:14:58,389 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-18 19:14:58,407 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-18 19:14:58,419 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-18 19:14:58,427 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-18 19:15:06,926 [INFO] --- Step 9: Clustering ---
2025-04-18 19:15:06,936 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-18 19:15:43,131 [INFO] Found 16 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-18 19:15:43,139 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-18 19:15:43,146 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-18 19:16:19,122 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R6_umap_clusters_leiden_res0.8.png
2025-04-18 19:16:25,169 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_CRC_BJM1_S2R6_spatial_clusters_leiden_res0.8.png
2025-04-18 19:16:25,178 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-18 19:16:25,184 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-18 19:17:30,842 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-18 19:17:32,417 [INFO] Saved rank_genes_groups plot to: processed_xenium_CRC_BJM1_S2R6_rank_genes_clusters_leiden_res0.8.png
2025-04-18 19:17:32,424 [INFO] --- Step 12: Saving Results ---
2025-04-18 19:17:32,437 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 57758, 'n_genes': 2000, 'median_total_counts': 456.0, 'mean_total_counts': 638.799072265625, 'median_n_genes_by_counts': 334.0, 'mean_n_genes_by_counts': 394.6123307593753, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-18 19:17:32,444 [INFO] Saving provenance information to: processed_xenium_CRC_BJM1_S2R6_provenance.json
2025-04-18 19:17:32,456 [INFO] Provenance data saved successfully.
2025-04-18 19:17:32,463 [INFO] Attempting to save final AnnData object to: processed_xenium_CRC_BJM1_S2R6_processed.h5ad
2025-04-18 19:17:45,470 [INFO] Successfully saved processed AnnData object to: processed_xenium_CRC_BJM1_S2R6_processed.h5ad
2025-04-18 19:17:45,477 [INFO] Preprocessing pipeline finished.
2025-04-18 19:17:45,493 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 19:17:45,500 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R7
2025-04-18 19:17:45,506 [INFO] Sample ID set to: CRC_BJM1_S2R7
2025-04-18 19:17:45,513 [INFO] --- Step 1: Loading Data ---
2025-04-18 19:17:45,520 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_7__20250205__113422/cell_feature_matrix.h5
2025-04-18 19:17:45,528 [ERROR] File not found: [Errno 2] Unable to synchronously open file (unable to open file: name = '/data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_7__20250205__113422/cell_feature_matrix.h5', errno = 2, error message = 'No such file or directory', flags = 0, o_flags = 0). Aborting.
2025-04-18 19:17:45,545 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-18 19:17:45,556 [INFO] Output prefix set to: processed_xenium_CRC_BJM1_S2R8
2025-04-18 19:17:45,562 [INFO] Sample ID set to: CRC_BJM1_S2R8
2025-04-18 19:17:45,568 [INFO] --- Step 1: Loading Data ---
2025-04-18 19:17:45,574 [INFO] Reading H5 file: /data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_8__20250205__113422/cell_feature_matrix.h5
2025-04-18 19:17:45,581 [ERROR] File not found: [Errno 2] Unable to synchronously open file (unable to open file: name = '/data/ARPAH/250210_CRC_BJM/output-XETG00274__0050585__Region_8__20250205__113422/cell_feature_matrix.h5', errno = 2, error message = 'No such file or directory', flags = 0, o_flags = 0). Aborting.
2025-04-18 20:28:55,104 [INFO] Computing initial centroids with sklearn.KMeans...
2025-04-18 20:29:39,805 [INFO] sklearn.KMeans initialization complete.
2025-04-18 20:29:43,755 [INFO] Iteration 1 of 10
2025-04-18 20:36:17,675 [INFO] Iteration 2 of 10
2025-04-18 20:43:24,613 [INFO] Converged after 2 iterations
2025-04-18 22:54:33,947 [INFO] GPU available: True (cuda), used: True
2025-04-18 22:54:33,949 [INFO] TPU available: False, using: 0 TPU cores
2025-04-18 22:54:33,950 [INFO] HPU available: False, using: 0 HPUs
2025-04-18 22:54:34,008 [INFO] LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
2025-04-18 23:10:17,064 [INFO] `Trainer.fit` stopped: `max_epochs=10` reached.
2025-04-21 00:19:56,355 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-21 00:19:56,426 [INFO] Output prefix set to: processed_xenium_PDAC
2025-04-21 00:19:56,434 [INFO] Sample ID set to: PDAC
2025-04-21 00:19:56,442 [INFO] --- Step 1: Loading Data ---
2025-04-21 00:19:56,454 [INFO] Reading H5 file: /data/ARPAH/250226_PDAC/output-XETG00274__0041133__Region_1__20250222__071920/cell_feature_matrix.h5
2025-04-21 00:20:01,393 [INFO] Reading cells parquet file: /data/ARPAH/250226_PDAC/output-XETG00274__0041133__Region_1__20250222__071920/cells.parquet
2025-04-21 00:20:01,763 [INFO] Initial AnnData object shape: (360569, 5001)
2025-04-21 00:20:01,771 [INFO] Available obs columns from H5: ['sample_id']
2025-04-21 00:20:01,782 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-21 00:20:01,790 [INFO] --- Step 2: Integrating Metadata ---
2025-04-21 00:20:01,798 [INFO] Joining metadata from cells parquet file.
2025-04-21 00:20:02,026 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-21 00:20:02,034 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-21 00:20:02,045 [INFO] Core info directory not provided. Skipping core info integration.
2025-04-21 00:20:02,052 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-21 00:20:02,064 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-21 00:20:02,083 [INFO] Identified 0 mitochondrial genes.
2025-04-21 00:20:02,091 [INFO] Identified 1 ribosomal genes.
2025-04-21 00:20:02,098 [INFO] Identified 4 hemoglobin genes.
2025-04-21 00:20:03,349 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 360569, 'n_genes': 5001, 'median_total_counts': 222.0, 'mean_total_counts': 309.9089050292969, 'median_n_genes_by_counts': 186.0, 'mean_n_genes_by_counts': 229.34192068647056, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 00:20:08,405 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_PDAC_qc_violin_before_filter.png
2025-04-21 00:20:08,412 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-21 00:20:08,419 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-21 00:20:10,464 [INFO] Filtered genes: 0 genes removed (< 3 cells).
2025-04-21 00:20:10,948 [INFO] Cells to remove based on min_genes (3): 2508
2025-04-21 00:20:11,012 [INFO] Cells to remove based on min_counts (10): 5257
2025-04-21 00:20:11,023 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-21 00:20:11,734 [INFO] Filtered cells: 5257 cells removed based on combined criteria.
2025-04-21 00:20:11,742 [INFO] AnnData shape after QC filtering: (355312, 5001)
2025-04-21 00:20:16,693 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_PDAC_qc_violin_after_filter.png
2025-04-21 00:20:16,701 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-21 00:20:17,297 [INFO] Saved log-normalized data to adata.raw
2025-04-21 00:20:17,305 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-21 00:20:17,312 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-21 00:20:17,632 [INFO] Applying log1p transformation.
2025-04-21 00:20:18,021 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-21 00:20:19,690 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-21 00:20:19,705 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-21 00:20:19,712 [INFO] --- Step 6: Scaling Data ---
2025-04-21 00:20:19,719 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-21 00:20:32,801 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-21 00:20:32,809 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-21 00:20:32,816 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-21 00:21:01,015 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-21 00:21:01,038 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-21 00:21:01,045 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-21 00:21:01,052 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-21 00:21:59,718 [INFO] --- Step 9: Clustering ---
2025-04-21 00:21:59,726 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-21 00:39:04,209 [INFO] Found 22 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-21 00:39:04,217 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-21 00:39:04,224 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-21 00:44:16,431 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_PDAC_umap_clusters_leiden_res0.8.png
2025-04-21 00:44:46,372 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_PDAC_spatial_clusters_leiden_res0.8.png
2025-04-21 00:44:46,380 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-21 00:44:46,387 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-21 00:45:52,079 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-21 00:45:54,132 [INFO] Saved rank_genes_groups plot to: processed_xenium_PDAC_rank_genes_clusters_leiden_res0.8.png
2025-04-21 00:45:54,140 [INFO] --- Step 12: Saving Results ---
2025-04-21 00:45:54,159 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 355312, 'n_genes': 2000, 'median_total_counts': 225.0, 'mean_total_counts': 314.4427490234375, 'median_n_genes_by_counts': 189.0, 'mean_n_genes_by_counts': 232.68558900346738, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 00:45:54,166 [INFO] Saving provenance information to: processed_xenium_PDAC_provenance.json
2025-04-21 00:45:54,177 [INFO] Provenance data saved successfully.
2025-04-21 00:45:54,184 [INFO] Attempting to save final AnnData object to: processed_xenium_PDAC_processed.h5ad
2025-04-21 00:46:56,209 [INFO] Successfully saved processed AnnData object to: processed_xenium_PDAC_processed.h5ad
2025-04-21 00:46:56,217 [INFO] Preprocessing pipeline finished.
2025-04-21 00:46:56,280 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-21 00:46:56,287 [INFO] Output prefix set to: processed_xenium_TNBCS1
2025-04-21 00:46:56,294 [INFO] Sample ID set to: TNBCS1
2025-04-21 00:46:56,301 [INFO] --- Step 1: Loading Data ---
2025-04-21 00:46:56,308 [INFO] Reading H5 file: /data/ARPAH/250305_TNBC_26/output-XETG00274__0040814__block26_slide1_reg1__20250228__073102/cell_feature_matrix.h5
2025-04-21 00:47:00,699 [INFO] Reading cells parquet file: /data/ARPAH/250305_TNBC_26/output-XETG00274__0040814__block26_slide1_reg1__20250228__073102/cells.parquet
2025-04-21 00:47:01,086 [INFO] Initial AnnData object shape: (367141, 5001)
2025-04-21 00:47:01,096 [INFO] Available obs columns from H5: ['sample_id']
2025-04-21 00:47:01,104 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-21 00:47:01,117 [INFO] --- Step 2: Integrating Metadata ---
2025-04-21 00:47:01,127 [INFO] Joining metadata from cells parquet file.
2025-04-21 00:47:01,377 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-21 00:47:01,385 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-21 00:47:01,397 [INFO] Core info directory not provided. Skipping core info integration.
2025-04-21 00:47:01,404 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-21 00:47:01,417 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-21 00:47:01,439 [INFO] Identified 0 mitochondrial genes.
2025-04-21 00:47:01,447 [INFO] Identified 1 ribosomal genes.
2025-04-21 00:47:01,457 [INFO] Identified 4 hemoglobin genes.
2025-04-21 00:47:02,579 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 367141, 'n_genes': 5001, 'median_total_counts': 175.0, 'mean_total_counts': 312.9900207519531, 'median_n_genes_by_counts': 148.0, 'mean_n_genes_by_counts': 225.19321187227794, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 00:47:07,419 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_TNBCS1_qc_violin_before_filter.png
2025-04-21 00:47:07,427 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-21 00:47:07,434 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-21 00:47:09,224 [INFO] Filtered genes: 0 genes removed (< 3 cells).
2025-04-21 00:47:09,618 [INFO] Cells to remove based on min_genes (3): 2973
2025-04-21 00:47:09,668 [INFO] Cells to remove based on min_counts (10): 9731
2025-04-21 00:47:09,679 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-21 00:47:10,379 [INFO] Filtered cells: 9731 cells removed based on combined criteria.
2025-04-21 00:47:10,387 [INFO] AnnData shape after QC filtering: (357410, 5001)
2025-04-21 00:47:15,068 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_TNBCS1_qc_violin_after_filter.png
2025-04-21 00:47:15,075 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-21 00:47:15,713 [INFO] Saved log-normalized data to adata.raw
2025-04-21 00:47:15,720 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-21 00:47:15,727 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-21 00:47:16,048 [INFO] Applying log1p transformation.
2025-04-21 00:47:16,418 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-21 00:47:18,020 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-21 00:47:18,047 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-21 00:47:18,054 [INFO] --- Step 6: Scaling Data ---
2025-04-21 00:47:18,061 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-21 00:47:31,350 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-21 00:47:31,363 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-21 00:47:31,370 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-21 00:47:59,710 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-21 00:47:59,743 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-21 00:47:59,752 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-21 00:47:59,760 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-21 00:48:53,182 [INFO] --- Step 9: Clustering ---
2025-04-21 00:48:53,190 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-21 01:02:18,548 [INFO] Found 26 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-21 01:02:18,557 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-21 01:02:18,564 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-21 01:07:21,976 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_TNBCS1_umap_clusters_leiden_res0.8.png
2025-04-21 01:07:50,752 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_TNBCS1_spatial_clusters_leiden_res0.8.png
2025-04-21 01:07:50,760 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-21 01:07:50,767 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-21 01:08:55,956 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-21 01:08:58,356 [INFO] Saved rank_genes_groups plot to: processed_xenium_TNBCS1_rank_genes_clusters_leiden_res0.8.png
2025-04-21 01:08:58,365 [INFO] --- Step 12: Saving Results ---
2025-04-21 01:08:58,389 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 357410, 'n_genes': 2000, 'median_total_counts': 182.0, 'mean_total_counts': 321.387939453125, 'median_n_genes_by_counts': 154.0, 'mean_n_genes_by_counts': 231.20640161159452, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 01:08:58,397 [INFO] Saving provenance information to: processed_xenium_TNBCS1_provenance.json
2025-04-21 01:08:58,410 [INFO] Provenance data saved successfully.
2025-04-21 01:08:58,419 [INFO] Attempting to save final AnnData object to: processed_xenium_TNBCS1_processed.h5ad
2025-04-21 01:10:00,923 [INFO] Successfully saved processed AnnData object to: processed_xenium_TNBCS1_processed.h5ad
2025-04-21 01:10:00,934 [INFO] Preprocessing pipeline finished.
2025-04-21 01:10:01,055 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-21 01:10:01,062 [INFO] Output prefix set to: processed_xenium_TNBCS2
2025-04-21 01:10:01,069 [INFO] Sample ID set to: TNBCS2
2025-04-21 01:10:01,076 [INFO] --- Step 1: Loading Data ---
2025-04-21 01:10:01,083 [INFO] Reading H5 file: /data/ARPAH/250305_TNBC_26/output-XETG00274__0040807__block26_slide2_reg1__20250228__073103/cell_feature_matrix.h5
2025-04-21 01:10:03,502 [INFO] Reading cells parquet file: /data/ARPAH/250305_TNBC_26/output-XETG00274__0040807__block26_slide2_reg1__20250228__073103/cells.parquet
2025-04-21 01:10:03,736 [INFO] Initial AnnData object shape: (248222, 5001)
2025-04-21 01:10:03,744 [INFO] Available obs columns from H5: ['sample_id']
2025-04-21 01:10:03,752 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-21 01:10:03,759 [INFO] --- Step 2: Integrating Metadata ---
2025-04-21 01:10:03,767 [INFO] Joining metadata from cells parquet file.
2025-04-21 01:10:03,931 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-21 01:10:03,939 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-21 01:10:03,951 [INFO] Core info directory not provided. Skipping core info integration.
2025-04-21 01:10:03,959 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-21 01:10:03,974 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-21 01:10:04,006 [INFO] Identified 0 mitochondrial genes.
2025-04-21 01:10:04,015 [INFO] Identified 1 ribosomal genes.
2025-04-21 01:10:04,026 [INFO] Identified 4 hemoglobin genes.
2025-04-21 01:10:04,877 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 248222, 'n_genes': 5001, 'median_total_counts': 126.0, 'mean_total_counts': 223.19625854492188, 'median_n_genes_by_counts': 109.0, 'mean_n_genes_by_counts': 168.31641433877738, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 01:10:08,351 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_TNBCS2_qc_violin_before_filter.png
2025-04-21 01:10:08,359 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-21 01:10:08,366 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-21 01:10:09,304 [INFO] Filtered genes: 0 genes removed (< 3 cells).
2025-04-21 01:10:09,524 [INFO] Cells to remove based on min_genes (3): 3047
2025-04-21 01:10:09,560 [INFO] Cells to remove based on min_counts (10): 10101
2025-04-21 01:10:09,571 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-21 01:10:09,933 [INFO] Filtered cells: 10101 cells removed based on combined criteria.
2025-04-21 01:10:09,941 [INFO] AnnData shape after QC filtering: (238121, 5001)
2025-04-21 01:10:13,262 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_TNBCS2_qc_violin_after_filter.png
2025-04-21 01:10:13,271 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-21 01:10:13,593 [INFO] Saved log-normalized data to adata.raw
2025-04-21 01:10:13,596 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-21 01:10:13,599 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-21 01:10:13,777 [INFO] Applying log1p transformation.
2025-04-21 01:10:13,977 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-21 01:10:15,012 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-21 01:10:15,029 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-21 01:10:15,037 [INFO] --- Step 6: Scaling Data ---
2025-04-21 01:10:15,044 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-21 01:10:22,535 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-21 01:10:22,544 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-21 01:10:22,551 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-21 01:10:42,422 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-21 01:10:42,440 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-21 01:10:42,451 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-21 01:10:42,458 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-21 01:11:13,304 [INFO] --- Step 9: Clustering ---
2025-04-21 01:11:13,311 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-21 01:18:29,421 [INFO] Found 22 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-21 01:18:29,429 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-21 01:18:29,438 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-21 01:21:40,659 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_TNBCS2_umap_clusters_leiden_res0.8.png
2025-04-21 01:22:02,113 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_TNBCS2_spatial_clusters_leiden_res0.8.png
2025-04-21 01:22:02,121 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-21 01:22:02,127 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-21 01:22:29,869 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-21 01:22:31,913 [INFO] Saved rank_genes_groups plot to: processed_xenium_TNBCS2_rank_genes_clusters_leiden_res0.8.png
2025-04-21 01:22:31,920 [INFO] --- Step 12: Saving Results ---
2025-04-21 01:22:31,936 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 238121, 'n_genes': 2000, 'median_total_counts': 134.0, 'mean_total_counts': 232.4702911376953, 'median_n_genes_by_counts': 115.0, 'mean_n_genes_by_counts': 175.27206756228975, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 01:22:31,943 [INFO] Saving provenance information to: processed_xenium_TNBCS2_provenance.json
2025-04-21 01:22:31,954 [INFO] Provenance data saved successfully.
2025-04-21 01:22:31,961 [INFO] Attempting to save final AnnData object to: processed_xenium_TNBCS2_processed.h5ad
2025-04-21 01:23:07,749 [INFO] Successfully saved processed AnnData object to: processed_xenium_TNBCS2_processed.h5ad
2025-04-21 01:23:07,757 [INFO] Preprocessing pipeline finished.
2025-04-21 01:23:07,784 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-21 01:23:07,791 [INFO] Output prefix set to: processed_xenium_SJH1
2025-04-21 01:23:07,798 [INFO] Sample ID set to: SJH1
2025-04-21 01:23:07,805 [INFO] --- Step 1: Loading Data ---
2025-04-21 01:23:07,812 [INFO] Reading H5 file: /data/ARPAH/250313_CRC_SJH/Xenium_Output/output-XETG00274__0027672__CRC__20250309__043920/cell_feature_matrix.h5
2025-04-21 01:23:10,902 [INFO] Reading cells parquet file: /data/ARPAH/250313_CRC_SJH/Xenium_Output/output-XETG00274__0027672__CRC__20250309__043920/cells.parquet
2025-04-21 01:23:11,150 [INFO] Initial AnnData object shape: (256247, 5001)
2025-04-21 01:23:11,159 [INFO] Available obs columns from H5: ['sample_id']
2025-04-21 01:23:11,170 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-21 01:23:11,178 [INFO] --- Step 2: Integrating Metadata ---
2025-04-21 01:23:11,186 [INFO] Joining metadata from cells parquet file.
2025-04-21 01:23:11,351 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-21 01:23:11,359 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-21 01:23:11,371 [INFO] Core info directory not provided. Skipping core info integration.
2025-04-21 01:23:11,378 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-21 01:23:11,393 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-21 01:23:11,422 [INFO] Identified 0 mitochondrial genes.
2025-04-21 01:23:11,431 [INFO] Identified 1 ribosomal genes.
2025-04-21 01:23:11,443 [INFO] Identified 4 hemoglobin genes.
2025-04-21 01:23:12,444 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 256247, 'n_genes': 5001, 'median_total_counts': 206.0, 'mean_total_counts': 343.0209045410156, 'median_n_genes_by_counts': 175.0, 'mean_n_genes_by_counts': 243.51344210859054, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 01:23:16,056 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_SJH1_qc_violin_before_filter.png
2025-04-21 01:23:16,063 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-21 01:23:16,070 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-21 01:23:17,479 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-21 01:23:17,808 [INFO] Cells to remove based on min_genes (3): 2039
2025-04-21 01:23:17,853 [INFO] Cells to remove based on min_counts (10): 6563
2025-04-21 01:23:17,863 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-21 01:23:18,366 [INFO] Filtered cells: 6563 cells removed based on combined criteria.
2025-04-21 01:23:18,374 [INFO] AnnData shape after QC filtering: (249684, 5000)
2025-04-21 01:23:21,788 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_SJH1_qc_violin_after_filter.png
2025-04-21 01:23:21,795 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-21 01:23:22,401 [INFO] Saved log-normalized data to adata.raw
2025-04-21 01:23:22,409 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-21 01:23:22,415 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-21 01:23:22,730 [INFO] Applying log1p transformation.
2025-04-21 01:23:23,028 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-21 01:23:24,264 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-21 01:23:24,280 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-21 01:23:24,288 [INFO] --- Step 6: Scaling Data ---
2025-04-21 01:23:24,295 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-21 01:23:33,336 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-21 01:23:33,347 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-21 01:23:33,354 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-21 01:23:54,209 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-21 01:23:54,229 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-21 01:23:54,236 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-21 01:23:54,244 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-21 01:24:25,641 [INFO] --- Step 9: Clustering ---
2025-04-21 01:24:25,649 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-21 01:33:26,777 [INFO] Found 19 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-21 01:33:26,785 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-21 01:33:26,792 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-21 01:36:44,538 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_SJH1_umap_clusters_leiden_res0.8.png
2025-04-21 01:37:07,060 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_SJH1_spatial_clusters_leiden_res0.8.png
2025-04-21 01:37:07,069 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-21 01:37:07,076 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-21 01:37:46,130 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-21 01:37:47,943 [INFO] Saved rank_genes_groups plot to: processed_xenium_SJH1_rank_genes_clusters_leiden_res0.8.png
2025-04-21 01:37:47,953 [INFO] --- Step 12: Saving Results ---
2025-04-21 01:37:47,973 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 249684, 'n_genes': 2000, 'median_total_counts': 213.0, 'mean_total_counts': 351.9185485839844, 'median_n_genes_by_counts': 181.0, 'mean_n_genes_by_counts': 249.79884173595426, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 01:37:47,982 [INFO] Saving provenance information to: processed_xenium_SJH1_provenance.json
2025-04-21 01:37:47,995 [INFO] Provenance data saved successfully.
2025-04-21 01:37:48,003 [INFO] Attempting to save final AnnData object to: processed_xenium_SJH1_processed.h5ad
2025-04-21 01:38:32,053 [INFO] Successfully saved processed AnnData object to: processed_xenium_SJH1_processed.h5ad
2025-04-21 01:38:32,063 [INFO] Preprocessing pipeline finished.
2025-04-21 01:38:32,091 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-21 01:38:32,099 [INFO] Output prefix set to: processed_xenium_SJH2
2025-04-21 01:38:32,106 [INFO] Sample ID set to: SJH2
2025-04-21 01:38:32,113 [INFO] --- Step 1: Loading Data ---
2025-04-21 01:38:32,120 [INFO] Reading H5 file: /data/ARPAH/250313_CRC_SJH/Xenium_Output/output-XETG00274__0027672__CRC__20250309__043920/cell_feature_matrix.h5
2025-04-21 01:38:35,227 [INFO] Reading cells parquet file: /data/ARPAH/250313_CRC_SJH/Xenium_Output/output-XETG00274__0027672__CRC__20250309__043920/cells.parquet
2025-04-21 01:38:35,404 [INFO] Initial AnnData object shape: (256247, 5001)
2025-04-21 01:38:35,413 [INFO] Available obs columns from H5: ['sample_id']
2025-04-21 01:38:35,421 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-21 01:38:35,429 [INFO] --- Step 2: Integrating Metadata ---
2025-04-21 01:38:35,436 [INFO] Joining metadata from cells parquet file.
2025-04-21 01:38:35,597 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-21 01:38:35,605 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-21 01:38:35,617 [INFO] Core info directory not provided. Skipping core info integration.
2025-04-21 01:38:35,625 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-21 01:38:35,639 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-21 01:38:35,670 [INFO] Identified 0 mitochondrial genes.
2025-04-21 01:38:35,679 [INFO] Identified 1 ribosomal genes.
2025-04-21 01:38:35,693 [INFO] Identified 4 hemoglobin genes.
2025-04-21 01:38:36,589 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 256247, 'n_genes': 5001, 'median_total_counts': 206.0, 'mean_total_counts': 343.0209045410156, 'median_n_genes_by_counts': 175.0, 'mean_n_genes_by_counts': 243.51344210859054, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 01:38:40,174 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_SJH2_qc_violin_before_filter.png
2025-04-21 01:38:40,182 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-21 01:38:40,189 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-21 01:38:41,741 [INFO] Filtered genes: 1 genes removed (< 3 cells).
2025-04-21 01:38:42,060 [INFO] Cells to remove based on min_genes (3): 2039
2025-04-21 01:38:42,105 [INFO] Cells to remove based on min_counts (10): 6563
2025-04-21 01:38:42,116 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-21 01:38:42,714 [INFO] Filtered cells: 6563 cells removed based on combined criteria.
2025-04-21 01:38:42,721 [INFO] AnnData shape after QC filtering: (249684, 5000)
2025-04-21 01:38:46,089 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_SJH2_qc_violin_after_filter.png
2025-04-21 01:38:46,096 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-21 01:38:46,746 [INFO] Saved log-normalized data to adata.raw
2025-04-21 01:38:46,753 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-21 01:38:46,760 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-21 01:38:47,035 [INFO] Applying log1p transformation.
2025-04-21 01:38:47,339 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-21 01:38:48,598 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-21 01:38:48,616 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-21 01:38:48,623 [INFO] --- Step 6: Scaling Data ---
2025-04-21 01:38:48,630 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-21 01:38:58,107 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-21 01:38:58,118 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-21 01:38:58,125 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-21 01:39:19,364 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-21 01:39:19,384 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-21 01:39:19,391 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-21 01:39:19,398 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-21 01:39:51,729 [INFO] --- Step 9: Clustering ---
2025-04-21 01:39:51,737 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-21 01:48:59,843 [INFO] Found 19 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-21 01:48:59,852 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-21 01:48:59,859 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-21 01:52:18,595 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_SJH2_umap_clusters_leiden_res0.8.png
2025-04-21 01:52:39,398 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_SJH2_spatial_clusters_leiden_res0.8.png
2025-04-21 01:52:39,406 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-21 01:52:39,413 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-21 01:53:13,049 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-21 01:53:14,781 [INFO] Saved rank_genes_groups plot to: processed_xenium_SJH2_rank_genes_clusters_leiden_res0.8.png
2025-04-21 01:53:14,789 [INFO] --- Step 12: Saving Results ---
2025-04-21 01:53:14,805 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 249684, 'n_genes': 2000, 'median_total_counts': 213.0, 'mean_total_counts': 351.9185485839844, 'median_n_genes_by_counts': 181.0, 'mean_n_genes_by_counts': 249.79884173595426, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 01:53:14,812 [INFO] Saving provenance information to: processed_xenium_SJH2_provenance.json
2025-04-21 01:53:14,823 [INFO] Provenance data saved successfully.
2025-04-21 01:53:14,830 [INFO] Attempting to save final AnnData object to: processed_xenium_SJH2_processed.h5ad
2025-04-21 01:53:57,416 [INFO] Successfully saved processed AnnData object to: processed_xenium_SJH2_processed.h5ad
2025-04-21 01:53:57,425 [INFO] Preprocessing pipeline finished.
2025-04-21 01:53:57,453 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-21 01:53:57,460 [INFO] Output prefix set to: processed_xenium_BJM_Set2_1
2025-04-21 01:53:57,467 [INFO] Sample ID set to: BJM_Set2_1
2025-04-21 01:53:57,474 [INFO] --- Step 1: Loading Data ---
2025-04-21 01:53:57,481 [INFO] Reading H5 file: /data/ARPAH/250323_CRC_BJM2/TA7047/output-XETG00274__0041134__Region_1__20250319__044828/cell_feature_matrix.h5
2025-04-21 01:54:01,202 [INFO] Reading cells parquet file: /data/ARPAH/250323_CRC_BJM2/TA7047/output-XETG00274__0041134__Region_1__20250319__044828/cells.parquet
2025-04-21 01:54:01,358 [INFO] Initial AnnData object shape: (224997, 5001)
2025-04-21 01:54:01,366 [INFO] Available obs columns from H5: ['sample_id']
2025-04-21 01:54:01,376 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-21 01:54:01,383 [INFO] --- Step 2: Integrating Metadata ---
2025-04-21 01:54:01,391 [INFO] Joining metadata from cells parquet file.
2025-04-21 01:54:01,538 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-21 01:54:01,546 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-21 01:54:01,559 [INFO] Core info directory not provided. Skipping core info integration.
2025-04-21 01:54:01,566 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-21 01:54:01,581 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-21 01:54:01,615 [INFO] Identified 0 mitochondrial genes.
2025-04-21 01:54:01,624 [INFO] Identified 1 ribosomal genes.
2025-04-21 01:54:01,636 [INFO] Identified 4 hemoglobin genes.
2025-04-21 01:54:02,804 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 224997, 'n_genes': 5001, 'median_total_counts': 346.0, 'mean_total_counts': 496.16705322265625, 'median_n_genes_by_counts': 271.0, 'mean_n_genes_by_counts': 330.667053338489, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 01:54:06,125 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_BJM_Set2_1_qc_violin_before_filter.png
2025-04-21 01:54:06,136 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-21 01:54:06,143 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-21 01:54:08,451 [INFO] Filtered genes: 0 genes removed (< 3 cells).
2025-04-21 01:54:08,905 [INFO] Cells to remove based on min_genes (3): 1976
2025-04-21 01:54:08,949 [INFO] Cells to remove based on min_counts (10): 5199
2025-04-21 01:54:08,961 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-21 01:54:09,494 [INFO] Filtered cells: 5199 cells removed based on combined criteria.
2025-04-21 01:54:09,503 [INFO] AnnData shape after QC filtering: (219798, 5001)
2025-04-21 01:54:12,634 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_BJM_Set2_1_qc_violin_after_filter.png
2025-04-21 01:54:12,642 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-21 01:54:13,484 [INFO] Saved log-normalized data to adata.raw
2025-04-21 01:54:13,492 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-21 01:54:13,502 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-21 01:54:13,957 [INFO] Applying log1p transformation.
2025-04-21 01:54:14,296 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-21 01:54:15,768 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-21 01:54:15,783 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-21 01:54:15,791 [INFO] --- Step 6: Scaling Data ---
2025-04-21 01:54:15,805 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-21 01:54:25,673 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-21 01:54:25,688 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-21 01:54:25,695 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-21 01:54:40,886 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-21 01:54:40,909 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-21 01:54:40,917 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-21 01:54:40,927 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-21 01:55:09,839 [INFO] --- Step 9: Clustering ---
2025-04-21 01:55:09,846 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-21 01:59:13,653 [INFO] Found 27 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-21 01:59:13,661 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-21 01:59:13,670 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-21 02:02:03,445 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_BJM_Set2_1_umap_clusters_leiden_res0.8.png
2025-04-21 02:02:23,679 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_BJM_Set2_1_spatial_clusters_leiden_res0.8.png
2025-04-21 02:02:23,687 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-21 02:02:23,694 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-21 02:03:06,450 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-21 02:03:08,939 [INFO] Saved rank_genes_groups plot to: processed_xenium_BJM_Set2_1_rank_genes_clusters_leiden_res0.8.png
2025-04-21 02:03:08,946 [INFO] --- Step 12: Saving Results ---
2025-04-21 02:03:08,962 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 219798, 'n_genes': 2000, 'median_total_counts': 358.0, 'mean_total_counts': 507.8060302734375, 'median_n_genes_by_counts': 278.0, 'mean_n_genes_by_counts': 338.3949262504663, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 02:03:08,969 [INFO] Saving provenance information to: processed_xenium_BJM_Set2_1_provenance.json
2025-04-21 02:03:08,980 [INFO] Provenance data saved successfully.
2025-04-21 02:03:08,987 [INFO] Attempting to save final AnnData object to: processed_xenium_BJM_Set2_1_processed.h5ad
2025-04-21 02:03:55,889 [INFO] Successfully saved processed AnnData object to: processed_xenium_BJM_Set2_1_processed.h5ad
2025-04-21 02:03:55,897 [INFO] Preprocessing pipeline finished.
2025-04-21 02:03:55,924 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-21 02:03:55,931 [INFO] Output prefix set to: processed_xenium_BJM_Set2_2
2025-04-21 02:03:55,938 [INFO] Sample ID set to: BJM_Set2_2
2025-04-21 02:03:55,945 [INFO] --- Step 1: Loading Data ---
2025-04-21 02:03:55,952 [INFO] Reading H5 file: /data/ARPAH/250323_CRC_BJM2/TA7047/output-XETG00274__0041134__Region_2__20250319__044828/cell_feature_matrix.h5
2025-04-21 02:03:59,542 [INFO] Reading cells parquet file: /data/ARPAH/250323_CRC_BJM2/TA7047/output-XETG00274__0041134__Region_2__20250319__044828/cells.parquet
2025-04-21 02:03:59,747 [INFO] Initial AnnData object shape: (226992, 5001)
2025-04-21 02:03:59,756 [INFO] Available obs columns from H5: ['sample_id']
2025-04-21 02:03:59,767 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-21 02:03:59,775 [INFO] --- Step 2: Integrating Metadata ---
2025-04-21 02:03:59,782 [INFO] Joining metadata from cells parquet file.
2025-04-21 02:03:59,924 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-21 02:03:59,934 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-21 02:03:59,947 [INFO] Core info directory not provided. Skipping core info integration.
2025-04-21 02:03:59,954 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-21 02:03:59,969 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-21 02:04:00,002 [INFO] Identified 0 mitochondrial genes.
2025-04-21 02:04:00,011 [INFO] Identified 1 ribosomal genes.
2025-04-21 02:04:00,021 [INFO] Identified 4 hemoglobin genes.
2025-04-21 02:04:01,109 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 226992, 'n_genes': 5001, 'median_total_counts': 317.0, 'mean_total_counts': 429.9176025390625, 'median_n_genes_by_counts': 251.0, 'mean_n_genes_by_counts': 300.5727778952562, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 02:04:04,411 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_BJM_Set2_2_qc_violin_before_filter.png
2025-04-21 02:04:04,420 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-21 02:04:04,428 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-21 02:04:06,203 [INFO] Filtered genes: 0 genes removed (< 3 cells).
2025-04-21 02:04:06,552 [INFO] Cells to remove based on min_genes (3): 1843
2025-04-21 02:04:06,597 [INFO] Cells to remove based on min_counts (10): 4414
2025-04-21 02:04:06,608 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-21 02:04:07,106 [INFO] Filtered cells: 4414 cells removed based on combined criteria.
2025-04-21 02:04:07,114 [INFO] AnnData shape after QC filtering: (222578, 5001)
2025-04-21 02:04:10,310 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_BJM_Set2_2_qc_violin_after_filter.png
2025-04-21 02:04:10,318 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-21 02:04:11,035 [INFO] Saved log-normalized data to adata.raw
2025-04-21 02:04:11,042 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-21 02:04:11,049 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-21 02:04:11,496 [INFO] Applying log1p transformation.
2025-04-21 02:04:11,830 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-21 02:04:13,233 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-21 02:04:13,248 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-21 02:04:13,256 [INFO] --- Step 6: Scaling Data ---
2025-04-21 02:04:13,264 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-21 02:04:22,849 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-21 02:04:22,860 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-21 02:04:22,867 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-21 02:04:38,071 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-21 02:04:38,092 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-21 02:04:38,099 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-21 02:04:38,107 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-21 02:05:07,955 [INFO] --- Step 9: Clustering ---
2025-04-21 02:05:07,963 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-21 02:13:05,544 [INFO] Found 24 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-21 02:13:05,552 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-21 02:13:05,559 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-21 02:15:50,036 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_BJM_Set2_2_umap_clusters_leiden_res0.8.png
2025-04-21 02:16:10,631 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_BJM_Set2_2_spatial_clusters_leiden_res0.8.png
2025-04-21 02:16:10,639 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-21 02:16:10,646 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-21 02:16:47,788 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-21 02:16:49,962 [INFO] Saved rank_genes_groups plot to: processed_xenium_BJM_Set2_2_rank_genes_clusters_leiden_res0.8.png
2025-04-21 02:16:49,970 [INFO] --- Step 12: Saving Results ---
2025-04-21 02:16:49,985 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 222578, 'n_genes': 2000, 'median_total_counts': 324.0, 'mean_total_counts': 438.36822509765625, 'median_n_genes_by_counts': 257.0, 'mean_n_genes_by_counts': 306.460894607733, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 02:16:49,993 [INFO] Saving provenance information to: processed_xenium_BJM_Set2_2_provenance.json
2025-04-21 02:16:50,004 [INFO] Provenance data saved successfully.
2025-04-21 02:16:50,010 [INFO] Attempting to save final AnnData object to: processed_xenium_BJM_Set2_2_processed.h5ad
2025-04-21 02:17:33,629 [INFO] Successfully saved processed AnnData object to: processed_xenium_BJM_Set2_2_processed.h5ad
2025-04-21 02:17:33,637 [INFO] Preprocessing pipeline finished.
2025-04-21 02:17:33,664 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-21 02:17:33,672 [INFO] Output prefix set to: processed_xenium_BJM_Set2_3
2025-04-21 02:17:33,678 [INFO] Sample ID set to: BJM_Set2_3
2025-04-21 02:17:33,685 [INFO] --- Step 1: Loading Data ---
2025-04-21 02:17:33,692 [INFO] Reading H5 file: /data/ARPAH/250323_CRC_BJM2/TA7048/output-XETG00274__0053073__Region_1__20250319__044828/cell_feature_matrix.h5
2025-04-21 02:17:37,493 [INFO] Reading cells parquet file: /data/ARPAH/250323_CRC_BJM2/TA7048/output-XETG00274__0053073__Region_1__20250319__044828/cells.parquet
2025-04-21 02:17:37,799 [INFO] Initial AnnData object shape: (280686, 5001)
2025-04-21 02:17:37,807 [INFO] Available obs columns from H5: ['sample_id']
2025-04-21 02:17:37,815 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-21 02:17:37,827 [INFO] --- Step 2: Integrating Metadata ---
2025-04-21 02:17:37,835 [INFO] Joining metadata from cells parquet file.
2025-04-21 02:17:38,010 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-21 02:17:38,019 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-21 02:17:38,030 [INFO] Core info directory not provided. Skipping core info integration.
2025-04-21 02:17:38,038 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-21 02:17:38,052 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-21 02:17:38,080 [INFO] Identified 0 mitochondrial genes.
2025-04-21 02:17:38,089 [INFO] Identified 1 ribosomal genes.
2025-04-21 02:17:38,099 [INFO] Identified 4 hemoglobin genes.
2025-04-21 02:17:39,264 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 280686, 'n_genes': 5001, 'median_total_counts': 240.0, 'mean_total_counts': 362.36041259765625, 'median_n_genes_by_counts': 201.0, 'mean_n_genes_by_counts': 259.9224934624456, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 02:17:43,062 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_BJM_Set2_3_qc_violin_before_filter.png
2025-04-21 02:17:43,070 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-21 02:17:43,077 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-21 02:17:44,972 [INFO] Filtered genes: 0 genes removed (< 3 cells).
2025-04-21 02:17:45,343 [INFO] Cells to remove based on min_genes (3): 1406
2025-04-21 02:17:45,392 [INFO] Cells to remove based on min_counts (10): 5773
2025-04-21 02:17:45,402 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-21 02:17:46,075 [INFO] Filtered cells: 5773 cells removed based on combined criteria.
2025-04-21 02:17:46,083 [INFO] AnnData shape after QC filtering: (274913, 5001)
2025-04-21 02:17:49,765 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_BJM_Set2_3_qc_violin_after_filter.png
2025-04-21 02:17:49,773 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-21 02:17:50,507 [INFO] Saved log-normalized data to adata.raw
2025-04-21 02:17:50,514 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-21 02:17:50,521 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-21 02:17:50,971 [INFO] Applying log1p transformation.
2025-04-21 02:17:51,304 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-21 02:17:52,705 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-21 02:17:52,720 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-21 02:17:52,727 [INFO] --- Step 6: Scaling Data ---
2025-04-21 02:17:52,734 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-21 02:18:02,935 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-21 02:18:02,946 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-21 02:18:02,953 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-21 02:18:23,769 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-21 02:18:23,788 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-21 02:18:23,795 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-21 02:18:23,802 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-21 02:19:03,023 [INFO] --- Step 9: Clustering ---
2025-04-21 02:19:03,030 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-21 02:31:16,846 [INFO] Found 24 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-21 02:31:16,854 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-21 02:31:16,865 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-21 02:34:57,228 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_BJM_Set2_3_umap_clusters_leiden_res0.8.png
2025-04-21 02:35:21,194 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_BJM_Set2_3_spatial_clusters_leiden_res0.8.png
2025-04-21 02:35:21,201 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-21 02:35:21,208 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-21 02:36:06,303 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-21 02:36:08,487 [INFO] Saved rank_genes_groups plot to: processed_xenium_BJM_Set2_3_rank_genes_clusters_leiden_res0.8.png
2025-04-21 02:36:08,494 [INFO] --- Step 12: Saving Results ---
2025-04-21 02:36:08,511 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 274913, 'n_genes': 2000, 'median_total_counts': 247.0, 'mean_total_counts': 369.8659362792969, 'median_n_genes_by_counts': 207.0, 'mean_n_genes_by_counts': 265.2795138825738, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 02:36:08,518 [INFO] Saving provenance information to: processed_xenium_BJM_Set2_3_provenance.json
2025-04-21 02:36:08,530 [INFO] Provenance data saved successfully.
2025-04-21 02:36:08,536 [INFO] Attempting to save final AnnData object to: processed_xenium_BJM_Set2_3_processed.h5ad
2025-04-21 02:36:57,537 [INFO] Successfully saved processed AnnData object to: processed_xenium_BJM_Set2_3_processed.h5ad
2025-04-21 02:36:57,544 [INFO] Preprocessing pipeline finished.
2025-04-21 02:36:57,576 [INFO] Starting Xenium data preprocessing pipeline.
2025-04-21 02:36:57,583 [INFO] Output prefix set to: processed_xenium_BJM_Set2_4
2025-04-21 02:36:57,590 [INFO] Sample ID set to: BJM_Set2_4
2025-04-21 02:36:57,597 [INFO] --- Step 1: Loading Data ---
2025-04-21 02:36:57,604 [INFO] Reading H5 file: /data/ARPAH/250323_CRC_BJM2/TA7048/output-XETG00274__0053073__Region_2__20250319__044828/cell_feature_matrix.h5
2025-04-21 02:37:01,209 [INFO] Reading cells parquet file: /data/ARPAH/250323_CRC_BJM2/TA7048/output-XETG00274__0053073__Region_2__20250319__044828/cells.parquet
2025-04-21 02:37:01,502 [INFO] Initial AnnData object shape: (263134, 5001)
2025-04-21 02:37:01,510 [INFO] Available obs columns from H5: ['sample_id']
2025-04-21 02:37:01,517 [INFO] Available var columns from H5: ['gene_ids', 'feature_types', 'genome']
2025-04-21 02:37:01,525 [INFO] --- Step 2: Integrating Metadata ---
2025-04-21 02:37:01,532 [INFO] Joining metadata from cells parquet file.
2025-04-21 02:37:01,709 [INFO] Added columns from cells parquet: ['transcript_counts', 'total_counts', 'genomic_control_counts', 'unassigned_codeword_counts', 'deprecated_codeword_counts', 'nucleus_area', 'nucleus_count', 'y_centroid', 'x_centroid', 'cell_area', 'control_codeword_counts', 'segmentation_method', 'control_probe_counts']
2025-04-21 02:37:01,717 [INFO] Populating adata.obsm['spatial'] using columns: 'x_centroid', 'y_centroid'
2025-04-21 02:37:01,729 [INFO] Core info directory not provided. Skipping core info integration.
2025-04-21 02:37:01,736 [INFO] Attempting to convert potentially problematic obs columns to string: ['Transcripts_core', 'Area (µm^2)_core']
2025-04-21 02:37:01,748 [INFO] --- Step 3: Calculating QC Metrics ---
2025-04-21 02:37:01,773 [INFO] Identified 0 mitochondrial genes.
2025-04-21 02:37:01,787 [INFO] Identified 1 ribosomal genes.
2025-04-21 02:37:01,799 [INFO] Identified 4 hemoglobin genes.
2025-04-21 02:37:02,768 [INFO] QC metrics calculated. Summary (before filtering): {'n_cells': 263134, 'n_genes': 5001, 'median_total_counts': 255.0, 'mean_total_counts': 380.71044921875, 'median_n_genes_by_counts': 213.0, 'mean_n_genes_by_counts': 272.35821292573365, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 02:37:06,364 [INFO] Saved QC violin plot (before filtering) to: processed_xenium_BJM_Set2_4_qc_violin_before_filter.png
2025-04-21 02:37:06,372 [INFO] --- Step 4: QC Filtering (Optional) ---
2025-04-21 02:37:06,378 [INFO] Applying QC filters with parameters: min_counts=10, max_counts=None, min_genes=3, max_genes=None, min_cells=3, max_pct_mito=20.0
2025-04-21 02:37:08,149 [INFO] Filtered genes: 0 genes removed (< 3 cells).
2025-04-21 02:37:08,471 [INFO] Cells to remove based on min_genes (3): 879
2025-04-21 02:37:08,510 [INFO] Cells to remove based on min_counts (10): 3752
2025-04-21 02:37:08,521 [INFO] Cells to remove based on max_pct_mito (20.0%): 0
2025-04-21 02:37:09,138 [INFO] Filtered cells: 3752 cells removed based on combined criteria.
2025-04-21 02:37:09,146 [INFO] AnnData shape after QC filtering: (259382, 5001)
2025-04-21 02:37:12,636 [INFO] Saved QC violin plot (after filtering) to: processed_xenium_BJM_Set2_4_qc_violin_after_filter.png
2025-04-21 02:37:12,643 [INFO] Preparing .raw attribute with log-normalized data.
2025-04-21 02:37:13,329 [INFO] Saved log-normalized data to adata.raw
2025-04-21 02:37:13,338 [INFO] --- Step 5: Normalization & HVG Selection (lognorm) ---
2025-04-21 02:37:13,345 [INFO] Applying LogNormalize: target_sum=10000.0
2025-04-21 02:37:13,769 [INFO] Applying log1p transformation.
2025-04-21 02:37:14,080 [INFO] Finding Highly Variable Genes (HVGs) using Scanpy method.
2025-04-21 02:37:15,449 [INFO] Found 2000 HVGs using parameters: {'min_mean': 0.0125, 'max_mean': 3, 'min_disp': 0.5, 'flavor': 'seurat_v3'}
2025-04-21 02:37:15,461 [WARNING] Could not generate HVG scatter plot: highly_variable_genes() got an unexpected keyword argument 'ax'
2025-04-21 02:37:15,465 [INFO] --- Step 6: Scaling Data ---
2025-04-21 02:37:15,472 [INFO] Scaling data to zero mean and unit variance (max_value=10).
2025-04-21 02:37:25,149 [INFO] Applied scaling to HVGs. adata.X now contains scaled log-normalized counts for HVGs.
2025-04-21 02:37:25,161 [INFO] --- Step 7: Dimensionality Reduction (PCA) ---
2025-04-21 02:37:25,168 [INFO] Running PCA with parameters: {'n_comps': 50, 'svd_solver': 'arpack', 'random_state': 0}
2025-04-21 02:37:44,114 [INFO] PCA performed on scaled log-normalized HVG data.
2025-04-21 02:37:44,134 [WARNING] Could not generate PCA variance ratio plot: pca_variance_ratio() got an unexpected keyword argument 'ax'
2025-04-21 02:37:44,141 [INFO] --- Step 8: Building Neighborhood Graph ---
2025-04-21 02:37:44,148 [INFO] Building KNN graph using parameters: {'n_neighbors': 15, 'n_pcs': 40, 'use_rep': 'X_pca', 'random_state': 0}
2025-04-21 02:38:18,706 [INFO] --- Step 9: Clustering ---
2025-04-21 02:38:18,713 [INFO] Running leiden clustering with parameters: {'resolution': 0.8, 'key_added': 'clusters_leiden_res0.8', 'random_state': 0}
2025-04-21 02:48:14,875 [INFO] Found 22 clusters using leiden (resolution=0.8). Results stored in adata.obs['clusters_leiden_res0.8'].
2025-04-21 02:48:14,883 [INFO] --- Step 10: Visualization (UMAP) ---
2025-04-21 02:48:14,890 [INFO] Running UMAP with parameters: {'min_dist': 0.5, 'spread': 1.0, 'random_state': 0}
2025-04-21 02:51:47,614 [INFO] Saved UMAP plot colored by 'clusters_leiden_res0.8' to: processed_xenium_BJM_Set2_4_umap_clusters_leiden_res0.8.png
2025-04-21 02:52:11,353 [INFO] Saved spatial plot colored by 'clusters_leiden_res0.8' to: processed_xenium_BJM_Set2_4_spatial_clusters_leiden_res0.8.png
2025-04-21 02:52:11,362 [INFO] --- Step 11: Finding Marker Genes ---
2025-04-21 02:52:11,369 [INFO] Running rank_genes_groups with parameters: {'groupby': 'clusters_leiden_res0.8', 'method': 'wilcoxon', 'key_added': 'clusters_leiden_res0.8_rank_genes_wilcoxon', 'use_raw': True, 'pts': True, 'n_genes': -1}
2025-04-21 02:52:48,169 [INFO] Marker gene analysis completed. Results stored in adata.uns['clusters_leiden_res0.8_rank_genes_wilcoxon'].
2025-04-21 02:52:50,191 [INFO] Saved rank_genes_groups plot to: processed_xenium_BJM_Set2_4_rank_genes_clusters_leiden_res0.8.png
2025-04-21 02:52:50,199 [INFO] --- Step 12: Saving Results ---
2025-04-21 02:52:50,215 [INFO] Final QC Summary (also logged in provenance): {'n_cells': 259382, 'n_genes': 2000, 'median_total_counts': 260.0, 'mean_total_counts': 386.1452941894531, 'median_n_genes_by_counts': 217.0, 'mean_n_genes_by_counts': 276.2275832555844, 'median_pct_counts_mt': 0.0, 'mean_pct_counts_mt': 0.0}
2025-04-21 02:52:50,222 [INFO] Saving provenance information to: processed_xenium_BJM_Set2_4_provenance.json
2025-04-21 02:52:50,233 [INFO] Provenance data saved successfully.
2025-04-21 02:52:50,240 [INFO] Attempting to save final AnnData object to: processed_xenium_BJM_Set2_4_processed.h5ad
2025-04-21 02:53:36,151 [INFO] Successfully saved processed AnnData object to: processed_xenium_BJM_Set2_4_processed.h5ad
2025-04-21 02:53:36,158 [INFO] Preprocessing pipeline finished.
